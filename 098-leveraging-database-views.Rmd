# Leveraging Database Views {#chapter_leveraging-datbase-views}

> This chapter demonstrates how to:
>
>   * Assess database views, understand their importance
>   * Unpack a database view and check its assumptions
>   * Create a database view either for personal use or for submittal to your enterprise DBA


## Setup our standard working environment

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(digits = 10)
sleep_default <- 1
```

Use these libraries:
```{r libraries, message=FALSE}
library(tidyverse)
library(DBI)
library(RPostgres)
library(glue)
require(knitr)
library(dbplyr)
library(sqlpetr)
library(bookdown)
library(here)
library(lubridate)
library(skimr)

library(scales) # ggplot xy scales
theme_set(theme_light())
```

Connect to `adventureworks`:
```{r, start adventureworks and connect}
sp_docker_start("adventureworks")
Sys.sleep(sleep_default)
con <- sp_get_postgres_connection(
  host = "localhost",
  port = 5432,
  user = "postgres",
  password = "postgres",
  dbname = "adventureworks",
  seconds_to_test = sleep_default, connection_tab = TRUE
)
```


## The role of database `views`

A database `view` is an SQL query that is stored in the database.  Most `views` are used for data retrieval, since they usually denormalize the tables involved.  Because they are standardized and well-understood, they can save you a lot of work.

### Why views are useful

Database `views` are useful for many reasons.

  * **Authoritative**: database `views` are typically written by the business application vendor or DBA, so they contain authoritative knowledge about the structure and intended use of the database.
  * **Performance**: `views` are designed to gather data in an efficient way, using all the indexes in an efficient sequence and doing as much work on the database server as possible.
  * **Abstraction**: `views` are abstractions or simplifications of complex queries that provide customary aggregations.  Common examples would be monthly totals or aggregation of activity tied to one individual.
  * **Reuse**: a `view` puts commonly used code in one place where it can be used by many people.
    * If you find any problems in a `view`, it only needs to be fixed in one place.
    * Simplifies downstream code, making it easier to read and maintain.
  * **Security**: a view can give selective access to someone who does not have access to underlying tables or columns.
  * **Provenance**: `views` standardize data provenance.  For example, the the `AdventureWorks` database all of them are named in a consistent way that suggests the underlying tables that they query.  And they all start with a **v**.

### Rely on and be critical of `views`

They are boring, but very important. May need verifidation or auditing -- not only as to whether they represent the enterprise correction but whether they meet your needs?  People may forget why a specific view exists, who is using it, etc., etc. Therefore any given view might be a forgoten vestige or part of an production data pipeline or might a priceless nugget of insight.

### How to unpack and inspect a `view`

Using a view to retireve data from the database will be completely standard across all flavors of SQL.

```{r}
v_salesperson_sales_by_fiscal_years_data <- 
  tbl(con, in_schema("sales","vsalespersonsalesbyfiscalyearsdata")) %>% 
  collect()

str(v_salesperson_sales_by_fiscal_years_data)

skim(v_salesperson_sales_by_fiscal_years_data)

v_salesperson_sales_by_fiscal_years_data %>% filter(salespersonid == 275)
```
Local idioms for looking at a view itself will vary.  Here is the code running the `pg_get_viewdef` function to retrieve a PostgreSQL view:

```{r}
view_definition <- dbGetQuery(con, "select 
                   pg_get_viewdef('sales.vsalespersonsalesbyfiscalyearsdata', 
                   true)")
str(view_definition)

cat(str_replace_all(view_definition$pg_get_viewdef, "\\\\\\\\n", "\\\\n")) 
  
```

Even if you don't intend to become fluent in SQL, it's useful to read as much of it as possible.  

### Use a view to test your understanding

  * What about by month? This could be motivation for creating a new view that does aggregation in the database, rather than in R.
  * See SQL code for 'vsalespersonsalesbyfiscalyearsdata'. Consider:
  * Modifying that to include quantity of sales.
  * Modifying that to include monthly totals, in addition to the yearly totals that it already has.
  * Why are 3 of the sales people from 'vsalesperson' missing in 'vsalespersonsalesbyfiscalyearsdata'?
     * Amy Alberts
     * Stephen Jiang
     * Syed Abbas
  * Making the change may not be your prerogative, but it's your responsibility to propose any reasonable changes to those who have the authority to make the make the change.

### First draft with dplyr

Save and study the SQL

t_salesperson_sales_by_fiscal_years_data 

```{r}
rm(t_salesperson_sales_by_fiscal_years_data)  # in case a previous version is lying around

t_salesperson_sales_by_fiscal_years_data <- 
  tbl(con, in_schema("sales", "salesperson")) %>% 
  select(-territoryid) %>% 
  
  left_join(tbl(con, in_schema("sales", "salesorderheader")), 
            by = c("businessentityid" = "salespersonid")) %>%
  mutate(fiscalyear = year(orderdate)) %>% 
  
  left_join(tbl(con, in_schema("sales", "salesterritory")), 
            by = c("territoryid" = "territoryid")) %>%
    rename(sales_territory = name) %>% 
  
  left_join(tbl(con, in_schema("humanresources", "employee")), 
            by = c("businessentityid" = "businessentityid")) %>%

    left_join(tbl(con, in_schema("person", "person")), 
              by = c("businessentityid" = "businessentityid")) %>%
  mutate(fullname = paste(firstname, middlename, lastname)) %>% 
  
  group_by(businessentityid, fullname, jobtitle, 
           sales_territory, fiscalyear) %>% 
  
  summarize(subtotal = sum(subtotal) ) %>% 
collect() %>% ungroup()

t_salesperson_sales_by_fiscal_years_data
skim(t_salesperson_sales_by_fiscal_years_data)

t_salesperson_sales_by_fiscal_years_data %>% 
  filter(businessentityid == 275)
```

Why 3 sales folks in vsalesperson donâ€™t show up in 2014 vsalespersonsalesbyfiscalyearsdata

Different environments / SQL dialects

## Save a `view` in the database

