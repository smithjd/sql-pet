<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Chapter 12 Joins and complex queries (13) | R, Databases and Docker</title>
  <meta name="description" content="An introduction to Docker and postgreSQL for R users to simulate use cases behind corporate walls.">
  <meta name="generator" content="bookdown  and GitBook 2.6.7">

  <meta property="og:title" content="Chapter 12 Joins and complex queries (13) | R, Databases and Docker />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="An introduction to Docker and postgreSQL for R users to simulate use cases behind corporate walls." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 12 Joins and complex queries (13) | R, Databases and Docker />
  
  <meta name="twitter:description" content="An introduction to Docker and postgreSQL for R users to simulate use cases behind corporate walls." />
  

<meta name="author" content="John David Smith, Sophie Yang, M. Edward (Ed) Borasky, Scott Came, Mary Anne Thygesen, Ian Frantz, and Dipti Muni">


<meta name="date" content="2018-12-29">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="dbi-and-sql-11c.html">
<link rel="next" href="sql-quick-start-simple-retrieval-15.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-1.3/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.5/datatables.js"></script>
<link href="libs/dt-core-1.10.16/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.16/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.16/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.0.0/js/crosstalk.min.js"></script>
<script src="libs/viz-0.3/viz.js"></script>
<link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet" />
<script src="libs/grViz-binding-1.0.0/grViz.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">R, Databases and Docker</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#using-r-to-query-a-dbms-in-your-organization"><i class="fa fa-check"></i><b>1.1</b> Using R to query a DBMS in your organization</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#docker-as-a-tool-for-users"><i class="fa fa-check"></i><b>1.2</b> Docker as a tool for UseRs</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#docker-and-r-on-your-machine"><i class="fa fa-check"></i><b>1.3</b> Docker and R on your machine</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#who-are-we"><i class="fa fa-check"></i><b>1.4</b> Who are we?</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#how-did-this-project-come-about"><i class="fa fa-check"></i><b>1.5</b> How did this project come about?</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="setup-instructions-00.html"><a href="setup-instructions-00.html"><i class="fa fa-check"></i><b>2</b> Setup instructions (00)</a><ul>
<li class="chapter" data-level="2.1" data-path="setup-instructions-00.html"><a href="setup-instructions-00.html#r-rstudio-and-git"><i class="fa fa-check"></i><b>2.1</b> R, RStudio and Git</a></li>
<li class="chapter" data-level="2.2" data-path="setup-instructions-00.html"><a href="setup-instructions-00.html#docker"><i class="fa fa-check"></i><b>2.2</b> Docker</a></li>
<li class="chapter" data-level="2.3" data-path="setup-instructions-00.html"><a href="setup-instructions-00.html#defining-the-postgresql-connection-parameters"><i class="fa fa-check"></i><b>2.3</b> Defining the PostgreSQL connection parameters</a></li>
<li class="chapter" data-level="2.4" data-path="setup-instructions-00.html"><a href="setup-instructions-00.html#participating"><i class="fa fa-check"></i><b>2.4</b> Participating</a><ul>
<li class="chapter" data-level="2.4.1" data-path="setup-instructions-00.html"><a href="setup-instructions-00.html#browsing-the-book"><i class="fa fa-check"></i><b>2.4.1</b> Browsing the book</a></li>
<li class="chapter" data-level="2.4.2" data-path="setup-instructions-00.html"><a href="setup-instructions-00.html#diving-in"><i class="fa fa-check"></i><b>2.4.2</b> Diving in</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="how-to-use-this-book-01.html"><a href="how-to-use-this-book-01.html"><i class="fa fa-check"></i><b>3</b> How to use this book (01)</a><ul>
<li class="chapter" data-level="3.1" data-path="how-to-use-this-book-01.html"><a href="how-to-use-this-book-01.html#prerequisites"><i class="fa fa-check"></i><b>3.1</b> Prerequisites</a></li>
<li class="chapter" data-level="3.2" data-path="how-to-use-this-book-01.html"><a href="how-to-use-this-book-01.html#installing-docker"><i class="fa fa-check"></i><b>3.2</b> Installing Docker</a></li>
<li class="chapter" data-level="3.3" data-path="how-to-use-this-book-01.html"><a href="how-to-use-this-book-01.html#download-the-repo"><i class="fa fa-check"></i><b>3.3</b> Download the repo</a></li>
<li class="chapter" data-level="3.4" data-path="how-to-use-this-book-01.html"><a href="how-to-use-this-book-01.html#read-along-experiment-as-you-go"><i class="fa fa-check"></i><b>3.4</b> Read along, experiment as you go</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="learning-goals-and-use-cases-03.html"><a href="learning-goals-and-use-cases-03.html"><i class="fa fa-check"></i><b>4</b> Learning Goals and Use Cases (03)</a><ul>
<li class="chapter" data-level="4.1" data-path="learning-goals-and-use-cases-03.html"><a href="learning-goals-and-use-cases-03.html#ask-yourself-what-are-you-aiming-for"><i class="fa fa-check"></i><b>4.1</b> Ask yourself, what are you aiming for?</a></li>
<li class="chapter" data-level="4.2" data-path="learning-goals-and-use-cases-03.html"><a href="learning-goals-and-use-cases-03.html#learning-goals"><i class="fa fa-check"></i><b>4.2</b> Learning Goals</a></li>
<li class="chapter" data-level="4.3" data-path="learning-goals-and-use-cases-03.html"><a href="learning-goals-and-use-cases-03.html#imagining-a-dvd-rental-business"><i class="fa fa-check"></i><b>4.3</b> Imagining a DVD rental business</a></li>
<li class="chapter" data-level="4.4" data-path="learning-goals-and-use-cases-03.html"><a href="learning-goals-and-use-cases-03.html#use-cases"><i class="fa fa-check"></i><b>4.4</b> Use cases</a></li>
<li class="chapter" data-level="4.5" data-path="learning-goals-and-use-cases-03.html"><a href="learning-goals-and-use-cases-03.html#investigating-a-question-using-with-an-organizations-database"><i class="fa fa-check"></i><b>4.5</b> Investigating a question using with an organization’s database</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="connecting-docker-postgres-and-r-04.html"><a href="connecting-docker-postgres-and-r-04.html"><i class="fa fa-check"></i><b>5</b> Connecting Docker, Postgres, and R (04)</a><ul>
<li class="chapter" data-level="5.1" data-path="connecting-docker-postgres-and-r-04.html"><a href="connecting-docker-postgres-and-r-04.html#verify-that-docker-is-running"><i class="fa fa-check"></i><b>5.1</b> Verify that Docker is running</a></li>
<li class="chapter" data-level="5.2" data-path="connecting-docker-postgres-and-r-04.html"><a href="connecting-docker-postgres-and-r-04.html#clean-up-if-appropriate"><i class="fa fa-check"></i><b>5.2</b> Clean up if appropriate</a></li>
<li class="chapter" data-level="5.3" data-path="connecting-docker-postgres-and-r-04.html"><a href="connecting-docker-postgres-and-r-04.html#connect-read-and-write-to-postgres-from-r"><i class="fa fa-check"></i><b>5.3</b> Connect, read and write to Postgres from R</a><ul>
<li class="chapter" data-level="5.3.1" data-path="connecting-docker-postgres-and-r-04.html"><a href="connecting-docker-postgres-and-r-04.html#connect-with-postgres"><i class="fa fa-check"></i><b>5.3.1</b> Connect with Postgres</a></li>
<li class="chapter" data-level="5.3.2" data-path="connecting-docker-postgres-and-r-04.html"><a href="connecting-docker-postgres-and-r-04.html#interact-with-postgres"><i class="fa fa-check"></i><b>5.3.2</b> Interact with Postgres</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="connecting-docker-postgres-and-r-04.html"><a href="connecting-docker-postgres-and-r-04.html#clean-up"><i class="fa fa-check"></i><b>5.4</b> Clean up</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="the-dvdrental-database-in-postgres-in-docker-05a.html"><a href="the-dvdrental-database-in-postgres-in-docker-05a.html"><i class="fa fa-check"></i><b>6</b> The dvdrental database in Postgres in Docker (05a)</a><ul>
<li class="chapter" data-level="6.1" data-path="the-dvdrental-database-in-postgres-in-docker-05a.html"><a href="the-dvdrental-database-in-postgres-in-docker-05a.html#overview"><i class="fa fa-check"></i><b>6.1</b> Overview</a></li>
<li class="chapter" data-level="6.2" data-path="the-dvdrental-database-in-postgres-in-docker-05a.html"><a href="the-dvdrental-database-in-postgres-in-docker-05a.html#verify-that-docker-is-up-and-running"><i class="fa fa-check"></i><b>6.2</b> Verify that Docker is up and running</a></li>
<li class="chapter" data-level="6.3" data-path="the-dvdrental-database-in-postgres-in-docker-05a.html"><a href="the-dvdrental-database-in-postgres-in-docker-05a.html#clean-up-if-appropriate-1"><i class="fa fa-check"></i><b>6.3</b> Clean up if appropriate</a></li>
<li class="chapter" data-level="6.4" data-path="the-dvdrental-database-in-postgres-in-docker-05a.html"><a href="the-dvdrental-database-in-postgres-in-docker-05a.html#build-the-pet-sql-docker-image"><i class="fa fa-check"></i><b>6.4</b> Build the pet-sql Docker Image</a></li>
<li class="chapter" data-level="6.5" data-path="the-dvdrental-database-in-postgres-in-docker-05a.html"><a href="the-dvdrental-database-in-postgres-in-docker-05a.html#run-the-pet-sql-docker-image"><i class="fa fa-check"></i><b>6.5</b> Run the pet-sql Docker Image</a></li>
<li class="chapter" data-level="6.6" data-path="the-dvdrental-database-in-postgres-in-docker-05a.html"><a href="the-dvdrental-database-in-postgres-in-docker-05a.html#connect-to-postgres-with-r"><i class="fa fa-check"></i><b>6.6</b> Connect to Postgres with R</a></li>
<li class="chapter" data-level="6.7" data-path="the-dvdrental-database-in-postgres-in-docker-05a.html"><a href="the-dvdrental-database-in-postgres-in-docker-05a.html#stop-and-start-to-demonstrate-persistence"><i class="fa fa-check"></i><b>6.7</b> Stop and start to demonstrate persistence</a></li>
<li class="chapter" data-level="6.8" data-path="the-dvdrental-database-in-postgres-in-docker-05a.html"><a href="the-dvdrental-database-in-postgres-in-docker-05a.html#cleaning-up"><i class="fa fa-check"></i><b>6.8</b> Cleaning up</a></li>
<li class="chapter" data-level="6.9" data-path="the-dvdrental-database-in-postgres-in-docker-05a.html"><a href="the-dvdrental-database-in-postgres-in-docker-05a.html#using-the-sql-pet-container-in-the-rest-of-the-book"><i class="fa fa-check"></i><b>6.9</b> Using the <code>sql-pet</code> container in the rest of the book</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="dbms-login.html"><a href="dbms-login.html"><i class="fa fa-check"></i><b>7</b> Securing and using your dbms log-in credentials (05b)</a><ul>
<li class="chapter" data-level="7.1" data-path="dbms-login.html"><a href="dbms-login.html#set-up-the-sql-pet-docker-container"><i class="fa fa-check"></i><b>7.1</b> Set up the sql-pet Docker container</a><ul>
<li class="chapter" data-level="7.1.1" data-path="dbms-login.html"><a href="dbms-login.html#verify-that-docker-is-running-1"><i class="fa fa-check"></i><b>7.1.1</b> Verify that Docker is running</a></li>
<li class="chapter" data-level="7.1.2" data-path="dbms-login.html"><a href="dbms-login.html#start-the-docker-container"><i class="fa fa-check"></i><b>7.1.2</b> Start the Docker container:</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="dbms-login.html"><a href="dbms-login.html#storing-your-dbms-credentials"><i class="fa fa-check"></i><b>7.2</b> Storing your dbms credentials</a><ul>
<li class="chapter" data-level="7.2.1" data-path="dbms-login.html"><a href="dbms-login.html#connect-with-postgres-using-the-sys.getenv-function"><i class="fa fa-check"></i><b>7.2.1</b> Connect with Postgres using the Sys.getenv function</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="dbms-login.html"><a href="dbms-login.html#clean-up-1"><i class="fa fa-check"></i><b>7.3</b> Clean up</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="your-local-environment.html"><a href="your-local-environment.html"><i class="fa fa-check"></i><b>8</b> Mapping your local environment (10)</a><ul>
<li class="chapter" data-level="8.1" data-path="your-local-environment.html"><a href="your-local-environment.html#set-up-our-standard-pet-sql-environment"><i class="fa fa-check"></i><b>8.1</b> Set up our standard pet-sql environment</a></li>
<li class="chapter" data-level="8.2" data-path="your-local-environment.html"><a href="your-local-environment.html#sandbox-environment"><i class="fa fa-check"></i><b>8.2</b> Sandbox Environment</a><ul>
<li class="chapter" data-level="8.2.1" data-path="your-local-environment.html"><a href="your-local-environment.html#sandbox-entities-and-their-roles"><i class="fa fa-check"></i><b>8.2.1</b> Sandbox entities and their roles</a></li>
<li class="chapter" data-level="8.2.2" data-path="your-local-environment.html"><a href="your-local-environment.html#rstudio"><i class="fa fa-check"></i><b>8.2.2</b> RStudio</a></li>
<li class="chapter" data-level="8.2.3" data-path="your-local-environment.html"><a href="your-local-environment.html#os-local-command-line-interface"><i class="fa fa-check"></i><b>8.2.3</b> OS / local command line interface</a></li>
<li class="chapter" data-level="8.2.4" data-path="your-local-environment.html"><a href="your-local-environment.html#r"><i class="fa fa-check"></i><b>8.2.4</b> R</a></li>
<li class="chapter" data-level="8.2.5" data-path="your-local-environment.html"><a href="your-local-environment.html#docker-client"><i class="fa fa-check"></i><b>8.2.5</b> Docker client</a></li>
<li class="chapter" data-level="8.2.6" data-path="your-local-environment.html"><a href="your-local-environment.html#in-docker-linux"><i class="fa fa-check"></i><b>8.2.6</b> In Docker: Linux</a></li>
<li class="chapter" data-level="8.2.7" data-path="your-local-environment.html"><a href="your-local-environment.html#in-docker-psql"><i class="fa fa-check"></i><b>8.2.7</b> In Docker: <code>psql</code></a></li>
<li class="chapter" data-level="8.2.8" data-path="your-local-environment.html"><a href="your-local-environment.html#in-docker-postgresql"><i class="fa fa-check"></i><b>8.2.8</b> In Docker: <code>postgreSQL</code></a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="your-local-environment.html"><a href="your-local-environment.html#getting-there-from-here-entity-connections-equivalence-and-commands"><i class="fa fa-check"></i><b>8.3</b> Getting there from here: entity connections, equivalence, and commands</a><ul>
<li class="chapter" data-level="8.3.1" data-path="your-local-environment.html"><a href="your-local-environment.html#get-info-on-a-local-file-from-r-code"><i class="fa fa-check"></i><b>8.3.1</b> Get info on a local file from R code</a></li>
<li class="chapter" data-level="8.3.2" data-path="your-local-environment.html"><a href="your-local-environment.html#get-info-on-the-same-os-file-inside-docker-from-r-code"><i class="fa fa-check"></i><b>8.3.2</b> Get info on the same OS file inside Docker from R Code</a></li>
<li class="chapter" data-level="8.3.3" data-path="your-local-environment.html"><a href="your-local-environment.html#docker-and-psql-together-from-r-or-your-cli"><i class="fa fa-check"></i><b>8.3.3</b> Docker and psql together from R or your CLI</a></li>
<li class="chapter" data-level="8.3.4" data-path="your-local-environment.html"><a href="your-local-environment.html#nesting-commands-illustrates-how-entities-are-connected"><i class="fa fa-check"></i><b>8.3.4</b> Nesting commands illustrates how entities are connected</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="your-local-environment.html"><a href="your-local-environment.html#exercises"><i class="fa fa-check"></i><b>8.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="introduction-to-dbms-queries-11a.html"><a href="introduction-to-dbms-queries-11a.html"><i class="fa fa-check"></i><b>9</b> Introduction to DBMS queries (11a)</a><ul>
<li class="chapter" data-level="9.1" data-path="introduction-to-dbms-queries-11a.html"><a href="introduction-to-dbms-queries-11a.html#getting-data-from-the-database"><i class="fa fa-check"></i><b>9.1</b> Getting data from the database</a><ul>
<li class="chapter" data-level="9.1.1" data-path="introduction-to-dbms-queries-11a.html"><a href="introduction-to-dbms-queries-11a.html#finding-out-whats-there"><i class="fa fa-check"></i><b>9.1.1</b> Finding out what’s there</a></li>
<li class="chapter" data-level="9.1.2" data-path="introduction-to-dbms-queries-11a.html"><a href="introduction-to-dbms-queries-11a.html#listing-all-the-fields-for-all-the-tables"><i class="fa fa-check"></i><b>9.1.2</b> Listing all the fields for all the tables</a></li>
<li class="chapter" data-level="9.1.3" data-path="introduction-to-dbms-queries-11a.html"><a href="introduction-to-dbms-queries-11a.html#downloading-an-entire-table"><i class="fa fa-check"></i><b>9.1.3</b> Downloading an entire table</a></li>
<li class="chapter" data-level="9.1.4" data-path="introduction-to-dbms-queries-11a.html"><a href="introduction-to-dbms-queries-11a.html#a-table-object-that-can-be-reused"><i class="fa fa-check"></i><b>9.1.4</b> A table object that can be reused</a></li>
<li class="chapter" data-level="9.1.5" data-path="introduction-to-dbms-queries-11a.html"><a href="introduction-to-dbms-queries-11a.html#controlling-the-number-of-rows-returned"><i class="fa fa-check"></i><b>9.1.5</b> Controlling the number of rows returned</a></li>
<li class="chapter" data-level="9.1.6" data-path="introduction-to-dbms-queries-11a.html"><a href="introduction-to-dbms-queries-11a.html#random-rows-from-the-dbms"><i class="fa fa-check"></i><b>9.1.6</b> Random rows from the dbms</a></li>
<li class="chapter" data-level="9.1.7" data-path="introduction-to-dbms-queries-11a.html"><a href="introduction-to-dbms-queries-11a.html#sub-setting-variables"><i class="fa fa-check"></i><b>9.1.7</b> Sub-setting variables</a></li>
<li class="chapter" data-level="9.1.8" data-path="introduction-to-dbms-queries-11a.html"><a href="introduction-to-dbms-queries-11a.html#translating-dplyr-code-to-sql-queries"><i class="fa fa-check"></i><b>9.1.8</b> Translating <code>dplyr</code> code to <code>SQL</code> queries</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="introduction-to-dbms-queries-11a.html"><a href="introduction-to-dbms-queries-11a.html#examining-a-single-table-with-r"><i class="fa fa-check"></i><b>9.2</b> Examining a single table with R</a><ul>
<li class="chapter" data-level="9.2.1" data-path="introduction-to-dbms-queries-11a.html"><a href="introduction-to-dbms-queries-11a.html#str---a-base-package-workhorse"><i class="fa fa-check"></i><b>9.2.1</b> <code>str</code> - a base package workhorse</a></li>
<li class="chapter" data-level="9.2.2" data-path="introduction-to-dbms-queries-11a.html"><a href="introduction-to-dbms-queries-11a.html#always-look-at-your-data-with-head-view-or-kable"><i class="fa fa-check"></i><b>9.2.2</b> Always <strong>look</strong> at your data with <code>head</code>, <code>View</code>, or <code>kable</code></a></li>
<li class="chapter" data-level="9.2.3" data-path="introduction-to-dbms-queries-11a.html"><a href="introduction-to-dbms-queries-11a.html#the-summary-function-in-base"><i class="fa fa-check"></i><b>9.2.3</b> The <code>summary</code> function in base</a></li>
<li class="chapter" data-level="9.2.4" data-path="introduction-to-dbms-queries-11a.html"><a href="introduction-to-dbms-queries-11a.html#the-glimpse-function-in-the-tibble-package"><i class="fa fa-check"></i><b>9.2.4</b> The <code>glimpse</code> function in the <code>tibble</code> package</a></li>
<li class="chapter" data-level="9.2.5" data-path="introduction-to-dbms-queries-11a.html"><a href="introduction-to-dbms-queries-11a.html#the-skim-function-in-the-skimr-package"><i class="fa fa-check"></i><b>9.2.5</b> The <code>skim</code> function in the <code>skimr</code> package</a></li>
<li class="chapter" data-level="9.2.6" data-path="introduction-to-dbms-queries-11a.html"><a href="introduction-to-dbms-queries-11a.html#close-the-connection-and-shut-down-sql-pet"><i class="fa fa-check"></i><b>9.2.6</b> Close the connection and shut down sql-pet</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="introduction-to-dbms-queries-11a.html"><a href="introduction-to-dbms-queries-11a.html#additional-reading"><i class="fa fa-check"></i><b>9.3</b> Additional reading</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="lazy-evaluation-and-lazy-queries-11b.html"><a href="lazy-evaluation-and-lazy-queries-11b.html"><i class="fa fa-check"></i><b>10</b> Lazy Evaluation and Lazy Queries (11b)</a><ul>
<li class="chapter" data-level="10.1" data-path="lazy-evaluation-and-lazy-queries-11b.html"><a href="lazy-evaluation-and-lazy-queries-11b.html#this-chapter"><i class="fa fa-check"></i><b>10.1</b> This chapter:</a><ul>
<li class="chapter" data-level="10.1.1" data-path="lazy-evaluation-and-lazy-queries-11b.html"><a href="lazy-evaluation-and-lazy-queries-11b.html#setup"><i class="fa fa-check"></i><b>10.1.1</b> Setup</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="lazy-evaluation-and-lazy-queries-11b.html"><a href="lazy-evaluation-and-lazy-queries-11b.html#r-is-lazy-and-comes-with-guardrails"><i class="fa fa-check"></i><b>10.2</b> R is lazy and comes with guardrails</a><ul>
<li class="chapter" data-level="10.2.1" data-path="lazy-evaluation-and-lazy-queries-11b.html"><a href="lazy-evaluation-and-lazy-queries-11b.html#lazy-loading"><i class="fa fa-check"></i><b>10.2.1</b> Lazy loading</a></li>
<li class="chapter" data-level="10.2.2" data-path="lazy-evaluation-and-lazy-queries-11b.html"><a href="lazy-evaluation-and-lazy-queries-11b.html#lazy-evaluation"><i class="fa fa-check"></i><b>10.2.2</b> Lazy evaluation</a></li>
<li class="chapter" data-level="10.2.3" data-path="lazy-evaluation-and-lazy-queries-11b.html"><a href="lazy-evaluation-and-lazy-queries-11b.html#lazy-queries"><i class="fa fa-check"></i><b>10.2.3</b> Lazy Queries</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="lazy-evaluation-and-lazy-queries-11b.html"><a href="lazy-evaluation-and-lazy-queries-11b.html#lazy-evaluation-and-lazy-queries"><i class="fa fa-check"></i><b>10.3</b> Lazy evaluation and lazy queries</a><ul>
<li class="chapter" data-level="10.3.1" data-path="lazy-evaluation-and-lazy-queries-11b.html"><a href="lazy-evaluation-and-lazy-queries-11b.html#dplyr-connection-objects"><i class="fa fa-check"></i><b>10.3.1</b> Dplyr connection objects</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="lazy-evaluation-and-lazy-queries-11b.html"><a href="lazy-evaluation-and-lazy-queries-11b.html#when-does-a-lazy-query-trigger-data-retrieval"><i class="fa fa-check"></i><b>10.4</b> When does a lazy query trigger data retrieval?</a><ul>
<li class="chapter" data-level="10.4.1" data-path="lazy-evaluation-and-lazy-queries-11b.html"><a href="lazy-evaluation-and-lazy-queries-11b.html#create-a-black-box-query-for-experimentation"><i class="fa fa-check"></i><b>10.4.1</b> Create a black box query for experimentation</a></li>
<li class="chapter" data-level="10.4.2" data-path="lazy-evaluation-and-lazy-queries-11b.html"><a href="lazy-evaluation-and-lazy-queries-11b.html#experiment-overview"><i class="fa fa-check"></i><b>10.4.2</b> Experiment overview</a></li>
<li class="chapter" data-level="10.4.3" data-path="lazy-evaluation-and-lazy-queries-11b.html"><a href="lazy-evaluation-and-lazy-queries-11b.html#lazy_q_print"><i class="fa fa-check"></i><b>10.4.3</b> Q %&gt;% print()</a></li>
<li class="chapter" data-level="10.4.4" data-path="lazy-evaluation-and-lazy-queries-11b.html"><a href="lazy-evaluation-and-lazy-queries-11b.html#lazy_q_as-tibble"><i class="fa fa-check"></i><b>10.4.4</b> Q %&gt;% as.tibble()</a></li>
<li class="chapter" data-level="10.4.5" data-path="lazy-evaluation-and-lazy-queries-11b.html"><a href="lazy-evaluation-and-lazy-queries-11b.html#lazy_q_head"><i class="fa fa-check"></i><b>10.4.5</b> Q %&gt;% head()</a></li>
<li class="chapter" data-level="10.4.6" data-path="lazy-evaluation-and-lazy-queries-11b.html"><a href="lazy-evaluation-and-lazy-queries-11b.html#lazy_q_length"><i class="fa fa-check"></i><b>10.4.6</b> Q %&gt;% length()</a></li>
<li class="chapter" data-level="10.4.7" data-path="lazy-evaluation-and-lazy-queries-11b.html"><a href="lazy-evaluation-and-lazy-queries-11b.html#lazy_q_str"><i class="fa fa-check"></i><b>10.4.7</b> Q %&gt;% str()</a></li>
<li class="chapter" data-level="10.4.8" data-path="lazy-evaluation-and-lazy-queries-11b.html"><a href="lazy-evaluation-and-lazy-queries-11b.html#lazy_q_nrow"><i class="fa fa-check"></i><b>10.4.8</b> Q %&gt;% nrow()</a></li>
<li class="chapter" data-level="10.4.9" data-path="lazy-evaluation-and-lazy-queries-11b.html"><a href="lazy-evaluation-and-lazy-queries-11b.html#lazy_q_tally"><i class="fa fa-check"></i><b>10.4.9</b> Q %&gt;% tally()</a></li>
<li class="chapter" data-level="10.4.10" data-path="lazy-evaluation-and-lazy-queries-11b.html"><a href="lazy-evaluation-and-lazy-queries-11b.html#lazy_q_collect"><i class="fa fa-check"></i><b>10.4.10</b> Q %&gt;% collect()</a></li>
<li class="chapter" data-level="10.4.11" data-path="lazy-evaluation-and-lazy-queries-11b.html"><a href="lazy-evaluation-and-lazy-queries-11b.html#lazy_q_show-query"><i class="fa fa-check"></i><b>10.4.11</b> Q %&gt;% show_query()</a></li>
<li class="chapter" data-level="10.4.12" data-path="lazy-evaluation-and-lazy-queries-11b.html"><a href="lazy-evaluation-and-lazy-queries-11b.html#lazy_q_build"><i class="fa fa-check"></i><b>10.4.12</b> Qc &lt;- Q %&gt;% count(customer_email)</a></li>
</ul></li>
<li class="chapter" data-level="10.5" data-path="lazy-evaluation-and-lazy-queries-11b.html"><a href="lazy-evaluation-and-lazy-queries-11b.html#other-resources"><i class="fa fa-check"></i><b>10.5</b> Other resources</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="dbi-and-sql-11c.html"><a href="dbi-and-sql-11c.html"><i class="fa fa-check"></i><b>11</b> DBI and SQL (11c)</a><ul>
<li class="chapter" data-level="11.1" data-path="dbi-and-sql-11c.html"><a href="dbi-and-sql-11c.html#this-chapter-1"><i class="fa fa-check"></i><b>11.1</b> This chapter:</a><ul>
<li class="chapter" data-level="11.1.1" data-path="dbi-and-sql-11c.html"><a href="dbi-and-sql-11c.html#setup-1"><i class="fa fa-check"></i><b>11.1.1</b> Setup</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="dbi-and-sql-11c.html"><a href="dbi-and-sql-11c.html#sql-in-r-markdown"><i class="fa fa-check"></i><b>11.2</b> SQL in R Markdown</a></li>
<li class="chapter" data-level="11.3" data-path="dbi-and-sql-11c.html"><a href="dbi-and-sql-11c.html#dbi-package"><i class="fa fa-check"></i><b>11.3</b> DBI Package</a><ul>
<li class="chapter" data-level="11.3.1" data-path="dbi-and-sql-11c.html"><a href="dbi-and-sql-11c.html#retrieve-the-whole-table"><i class="fa fa-check"></i><b>11.3.1</b> Retrieve the whole table</a></li>
<li class="chapter" data-level="11.3.2" data-path="dbi-and-sql-11c.html"><a href="dbi-and-sql-11c.html#or-a-chunk-at-a-time"><i class="fa fa-check"></i><b>11.3.2</b> Or a chunk at a time</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="dbi-and-sql-11c.html"><a href="dbi-and-sql-11c.html#dividing-the-work-between-r-on-your-machine-and-the-dbms"><i class="fa fa-check"></i><b>11.4</b> Dividing the work between R on your machine and the DBMS</a><ul>
<li class="chapter" data-level="11.4.1" data-path="dbi-and-sql-11c.html"><a href="dbi-and-sql-11c.html#make-the-server-do-as-much-work-as-you-can"><i class="fa fa-check"></i><b>11.4.1</b> Make the server do as much work as you can</a></li>
<li class="chapter" data-level="11.4.2" data-path="dbi-and-sql-11c.html"><a href="dbi-and-sql-11c.html#criteria-for-choosing-between-dplyr-and-native-sql"><i class="fa fa-check"></i><b>11.4.2</b> Criteria for choosing between <code>dplyr</code> and native SQL</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html"><i class="fa fa-check"></i><b>12</b> Joins and complex queries (13)</a><ul>
<li class="chapter" data-level="12.1" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#database-privileges"><i class="fa fa-check"></i><b>12.1</b> Database Privileges</a></li>
<li class="chapter" data-level="12.2" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#database-constraints"><i class="fa fa-check"></i><b>12.2</b> Database constraints</a><ul>
<li class="chapter" data-level="12.2.1" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#dvd-rental-primary-foreign-key-constraints"><i class="fa fa-check"></i><b>12.2.1</b> DVD Rental Primary Foreign Key Constraints</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#making-up-data-for-join-examples"><i class="fa fa-check"></i><b>12.3</b> Making up data for Join Examples</a><ul>
<li class="chapter" data-level="12.3.1" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#sql-delete-data-syntax"><i class="fa fa-check"></i><b>12.3.1</b> SQL Delete Data Syntax</a></li>
<li class="chapter" data-level="12.3.2" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#delete-new-practice-customers-from-the-customer-table."><i class="fa fa-check"></i><b>12.3.2</b> Delete New Practice Customers from the Customer table.</a></li>
<li class="chapter" data-level="12.3.3" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#delete-new-practice-films-from-the-film-table."><i class="fa fa-check"></i><b>12.3.3</b> Delete New Practice Films from the Film table.</a></li>
<li class="chapter" data-level="12.3.4" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#sql-single-row-insert-data-syntax"><i class="fa fa-check"></i><b>12.3.4</b> SQL Single Row Insert Data Syntax</a></li>
<li class="chapter" data-level="12.3.5" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#primary-and-foreign-key-constraint-error-messages"><i class="fa fa-check"></i><b>12.3.5</b> Primary and Foreign Key Constraint Error Messages</a></li>
<li class="chapter" data-level="12.3.6" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#r-exercise-inserting-a-single-row-via-a-dataframe"><i class="fa fa-check"></i><b>12.3.6</b> R Exercise: Inserting a Single Row via a Dataframe</a></li>
</ul></li>
<li class="chapter" data-level="12.4" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#sql-multi-row-insert-data-syntax"><i class="fa fa-check"></i><b>12.4</b> SQL Multi-Row Insert Data Syntax</a></li>
<li class="chapter" data-level="12.5" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#sql-multi-row-insert-data-example"><i class="fa fa-check"></i><b>12.5</b> SQL Multi-Row Insert Data Example</a><ul>
<li class="chapter" data-level="12.5.1" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#r-exercise-inserting-multiple-rows-via-a-dataframe"><i class="fa fa-check"></i><b>12.5.1</b> R Exercise: Inserting Multiple Rows via a Dataframe</a></li>
</ul></li>
<li class="chapter" data-level="12.6" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#messy-data"><i class="fa fa-check"></i><b>12.6</b> Messy Data</a><ul>
<li class="chapter" data-level="12.6.1" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#messing-up-the-row"><i class="fa fa-check"></i><b>12.6.1</b> Messing up the row</a></li>
</ul></li>
<li class="chapter" data-level="12.7" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#joins"><i class="fa fa-check"></i><b>12.7</b> Joins</a><ul>
<li class="chapter" data-level="12.7.1" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#join-types"><i class="fa fa-check"></i><b>12.7.1</b> Join Types</a></li>
<li class="chapter" data-level="12.7.2" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#valentines-party"><i class="fa fa-check"></i><b>12.7.2</b> Valentines Party</a></li>
<li class="chapter" data-level="12.7.3" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#join-syntax"><i class="fa fa-check"></i><b>12.7.3</b> Join Syntax</a></li>
<li class="chapter" data-level="12.7.4" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#join-tables"><i class="fa fa-check"></i><b>12.7.4</b> Join Tables</a></li>
</ul></li>
<li class="chapter" data-level="12.8" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#natural-join-delayed-time-bomb"><i class="fa fa-check"></i><b>12.8</b> Natural Join Delayed Time Bomb</a><ul>
<li class="chapter" data-level="12.8.1" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#dplyr-language-distribution-exercise"><i class="fa fa-check"></i><b>12.8.1</b> dplyr language distribution Exercise</a></li>
</ul></li>
<li class="chapter" data-level="12.9" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#join-templates"><i class="fa fa-check"></i><b>12.9</b> Join Templates</a><ul>
<li class="chapter" data-level="12.9.1" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#dplyr-inner-join-template"><i class="fa fa-check"></i><b>12.9.1</b> dplyr Inner Join Template</a></li>
<li class="chapter" data-level="12.9.2" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#dplyr-left-outer-join-template"><i class="fa fa-check"></i><b>12.9.2</b> dplyr Left Outer Join Template</a></li>
</ul></li>
<li class="chapter" data-level="12.10" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#sql-anti-join-costs"><i class="fa fa-check"></i><b>12.10</b> SQL anti join Costs</a></li>
<li class="chapter" data-level="12.11" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#dplyr-anti-joins"><i class="fa fa-check"></i><b>12.11</b> dplyr Anti joins</a><ul>
<li class="chapter" data-level="12.11.1" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#dplyr-costs"><i class="fa fa-check"></i><b>12.11.1</b> dplyr Costs</a></li>
</ul></li>
<li class="chapter" data-level="12.12" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#exercises-1"><i class="fa fa-check"></i><b>12.12</b> Exercises</a><ul>
<li class="chapter" data-level="12.12.1" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#anti-joins-find-customers-who-have-never-rented-a-movie-take-2."><i class="fa fa-check"></i><b>12.12.1</b> Anti joins – Find customers who have never rented a movie, take 2.</a></li>
<li class="chapter" data-level="12.12.2" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#sql-rows-per-table"><i class="fa fa-check"></i><b>12.12.2</b> SQL Rows Per Table</a></li>
</ul></li>
<li class="chapter" data-level="12.13" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#store-analysis"><i class="fa fa-check"></i><b>12.13</b> Store analysis</a><ul>
<li class="chapter" data-level="12.13.1" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#sql-store-revenue-stream"><i class="fa fa-check"></i><b>12.13.1</b> SQL store revenue stream</a></li>
<li class="chapter" data-level="12.13.2" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#sqlestimate-outstanding-balance"><i class="fa fa-check"></i><b>12.13.2</b> SQL:Estimate Outstanding Balance</a></li>
<li class="chapter" data-level="12.13.3" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#sql-actual-outstanding-balance"><i class="fa fa-check"></i><b>12.13.3</b> SQL actual outstanding balance</a></li>
<li class="chapter" data-level="12.13.4" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#rank-customers-with-highest-open-amounts"><i class="fa fa-check"></i><b>12.13.4</b> Rank customers with highest open amounts</a></li>
<li class="chapter" data-level="12.13.5" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#what-film-has-been-rented-the-most"><i class="fa fa-check"></i><b>12.13.5</b> what film has been rented the most</a></li>
<li class="chapter" data-level="12.13.6" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#what-film-has-been-generated-the-most-revenue-assuming-all-amounts-are-collected"><i class="fa fa-check"></i><b>12.13.6</b> what film has been generated the most revenue assuming all amounts are collected</a></li>
<li class="chapter" data-level="12.13.7" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#which-films-are-in-one-store-but-not-the-other."><i class="fa fa-check"></i><b>12.13.7</b> which films are in one store but not the other.</a></li>
<li class="chapter" data-level="12.13.8" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#compute-the-outstanding-balance."><i class="fa fa-check"></i><b>12.13.8</b> Compute the outstanding balance.</a></li>
</ul></li>
<li class="chapter" data-level="12.14" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#different-strategies-for-interacting-with-the-database"><i class="fa fa-check"></i><b>12.14</b> Different strategies for interacting with the database</a><ul>
<li class="chapter" data-level="12.14.1" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#use-dbgetquery"><i class="fa fa-check"></i><b>12.14.1</b> Use dbGetQuery</a></li>
<li class="chapter" data-level="12.14.2" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#use-dbexecute"><i class="fa fa-check"></i><b>12.14.2</b> Use dbExecute</a></li>
<li class="chapter" data-level="12.14.3" data-path="joins-and-complex-queries-13.html"><a href="joins-and-complex-queries-13.html#anti-join-find-sophie-who-has-never-rented-a-movie."><i class="fa fa-check"></i><b>12.14.3</b> Anti join – Find Sophie who has never rented a movie.</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="sql-quick-start-simple-retrieval-15.html"><a href="sql-quick-start-simple-retrieval-15.html"><i class="fa fa-check"></i><b>13</b> SQL Quick start - simple retrieval (15)</a><ul>
<li class="chapter" data-level="13.1" data-path="sql-quick-start-simple-retrieval-15.html"><a href="sql-quick-start-simple-retrieval-15.html#intro"><i class="fa fa-check"></i><b>13.1</b> Intro</a></li>
<li class="chapter" data-level="13.2" data-path="sql-quick-start-simple-retrieval-15.html"><a href="sql-quick-start-simple-retrieval-15.html#databases-and-third-normal-form---3nf"><i class="fa fa-check"></i><b>13.2</b> Databases and Third Normal Form - 3NF</a></li>
<li class="chapter" data-level="13.3" data-path="sql-quick-start-simple-retrieval-15.html"><a href="sql-quick-start-simple-retrieval-15.html#sql-commands"><i class="fa fa-check"></i><b>13.3</b> SQL Commands</a></li>
<li class="chapter" data-level="13.4" data-path="sql-quick-start-simple-retrieval-15.html"><a href="sql-quick-start-simple-retrieval-15.html#sql-select-quick-start"><i class="fa fa-check"></i><b>13.4</b> SQL SELECT Quick Start</a><ul>
<li class="chapter" data-level="13.4.1" data-path="sql-quick-start-simple-retrieval-15.html"><a href="sql-quick-start-simple-retrieval-15.html#select-clause-column-selection-vertical-partioning-of-data"><i class="fa fa-check"></i><b>13.4.1</b> SELECT Clause: Column Selection – Vertical Partioning of Data</a></li>
<li class="chapter" data-level="13.4.2" data-path="sql-quick-start-simple-retrieval-15.html"><a href="sql-quick-start-simple-retrieval-15.html#sql-comments"><i class="fa fa-check"></i><b>13.4.2</b> SQL Comments</a></li>
<li class="chapter" data-level="13.4.3" data-path="sql-quick-start-simple-retrieval-15.html"><a href="sql-quick-start-simple-retrieval-15.html#from-clause"><i class="fa fa-check"></i><b>13.4.3</b> FROM Clause</a></li>
<li class="chapter" data-level="13.4.4" data-path="sql-quick-start-simple-retrieval-15.html"><a href="sql-quick-start-simple-retrieval-15.html#where-clause-row-selection-horizontal-partitioning-of-data"><i class="fa fa-check"></i><b>13.4.4</b> WHERE Clause: Row Selection – Horizontal Partitioning of Data</a></li>
</ul></li>
<li class="chapter" data-level="13.5" data-path="sql-quick-start-simple-retrieval-15.html"><a href="sql-quick-start-simple-retrieval-15.html#paradigm-shift-from-r-dplyr-to-sql"><i class="fa fa-check"></i><b>13.5</b> Paradigm Shift from R-Dplyr to SQL</a><ul>
<li class="chapter" data-level="13.5.1" data-path="sql-quick-start-simple-retrieval-15.html"><a href="sql-quick-start-simple-retrieval-15.html#big-bang-versus-piped-incremental-steps."><i class="fa fa-check"></i><b>13.5.1</b> Big bang versus piped incremental steps.</a></li>
<li class="chapter" data-level="13.5.2" data-path="sql-quick-start-simple-retrieval-15.html"><a href="sql-quick-start-simple-retrieval-15.html#sql-execution-order"><i class="fa fa-check"></i><b>13.5.2</b> SQL Execution Order</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="getting-metadata-about-and-from-the-database-21.html"><a href="getting-metadata-about-and-from-the-database-21.html"><i class="fa fa-check"></i><b>14</b> Getting metadata about and from the database (21)</a><ul>
<li class="chapter" data-level="14.1" data-path="getting-metadata-about-and-from-the-database-21.html"><a href="getting-metadata-about-and-from-the-database-21.html#database-contents-and-structure"><i class="fa fa-check"></i><b>14.1</b> Database contents and structure</a><ul>
<li class="chapter" data-level="14.1.1" data-path="getting-metadata-about-and-from-the-database-21.html"><a href="getting-metadata-about-and-from-the-database-21.html#database-structure"><i class="fa fa-check"></i><b>14.1.1</b> Database structure</a></li>
<li class="chapter" data-level="14.1.2" data-path="getting-metadata-about-and-from-the-database-21.html"><a href="getting-metadata-about-and-from-the-database-21.html#contents-of-the-information_schema"><i class="fa fa-check"></i><b>14.1.2</b> Contents of the <code>information_schema</code></a></li>
<li class="chapter" data-level="14.1.3" data-path="getting-metadata-about-and-from-the-database-21.html"><a href="getting-metadata-about-and-from-the-database-21.html#what-tables-are-in-the-database"><i class="fa fa-check"></i><b>14.1.3</b> What tables are in the database?</a></li>
<li class="chapter" data-level="14.1.4" data-path="getting-metadata-about-and-from-the-database-21.html"><a href="getting-metadata-about-and-from-the-database-21.html#digging-into-the-information_schema"><i class="fa fa-check"></i><b>14.1.4</b> Digging into the <code>information_schema</code></a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="getting-metadata-about-and-from-the-database-21.html"><a href="getting-metadata-about-and-from-the-database-21.html#what-columns-do-those-tables-contain"><i class="fa fa-check"></i><b>14.2</b> What columns do those tables contain?</a><ul>
<li class="chapter" data-level="14.2.1" data-path="getting-metadata-about-and-from-the-database-21.html"><a href="getting-metadata-about-and-from-the-database-21.html#what-is-the-difference-between-a-view-and-a-base-table"><i class="fa fa-check"></i><b>14.2.1</b> What is the difference between a <code>VIEW</code> and a <code>BASE TABLE</code>?</a></li>
<li class="chapter" data-level="14.2.2" data-path="getting-metadata-about-and-from-the-database-21.html"><a href="getting-metadata-about-and-from-the-database-21.html#what-data-types-are-found-in-the-database"><i class="fa fa-check"></i><b>14.2.2</b> What data types are found in the database?</a></li>
</ul></li>
<li class="chapter" data-level="14.3" data-path="getting-metadata-about-and-from-the-database-21.html"><a href="getting-metadata-about-and-from-the-database-21.html#characterizing-how-things-are-named"><i class="fa fa-check"></i><b>14.3</b> Characterizing how things are named</a><ul>
<li class="chapter" data-level="14.3.1" data-path="getting-metadata-about-and-from-the-database-21.html"><a href="getting-metadata-about-and-from-the-database-21.html#counting-columns-and-name-reuse"><i class="fa fa-check"></i><b>14.3.1</b> Counting columns and name reuse</a></li>
</ul></li>
<li class="chapter" data-level="14.4" data-path="getting-metadata-about-and-from-the-database-21.html"><a href="getting-metadata-about-and-from-the-database-21.html#database-keys"><i class="fa fa-check"></i><b>14.4</b> Database keys</a><ul>
<li class="chapter" data-level="14.4.1" data-path="getting-metadata-about-and-from-the-database-21.html"><a href="getting-metadata-about-and-from-the-database-21.html#direct-sql"><i class="fa fa-check"></i><b>14.4.1</b> Direct SQL</a></li>
<li class="chapter" data-level="14.4.2" data-path="getting-metadata-about-and-from-the-database-21.html"><a href="getting-metadata-about-and-from-the-database-21.html#database-keys-with-dplyr"><i class="fa fa-check"></i><b>14.4.2</b> Database keys with dplyr</a></li>
</ul></li>
<li class="chapter" data-level="14.5" data-path="getting-metadata-about-and-from-the-database-21.html"><a href="getting-metadata-about-and-from-the-database-21.html#creating-your-own-data-dictionary"><i class="fa fa-check"></i><b>14.5</b> Creating your own data dictionary</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="drilling-into-your-dbms-environment-22.html"><a href="drilling-into-your-dbms-environment-22.html"><i class="fa fa-check"></i><b>15</b> Drilling into your DBMS environment (22)</a><ul>
<li class="chapter" data-level="15.1" data-path="drilling-into-your-dbms-environment-22.html"><a href="drilling-into-your-dbms-environment-22.html#which-database"><i class="fa fa-check"></i><b>15.1</b> Which database?</a></li>
<li class="chapter" data-level="15.2" data-path="drilling-into-your-dbms-environment-22.html"><a href="drilling-into-your-dbms-environment-22.html#how-many-databases-reside-in-the-docker-container"><i class="fa fa-check"></i><b>15.2</b> How many databases reside in the Docker Container?</a></li>
<li class="chapter" data-level="15.3" data-path="drilling-into-your-dbms-environment-22.html"><a href="drilling-into-your-dbms-environment-22.html#which-schema"><i class="fa fa-check"></i><b>15.3</b> Which Schema?</a></li>
<li class="chapter" data-level="15.4" data-path="drilling-into-your-dbms-environment-22.html"><a href="drilling-into-your-dbms-environment-22.html#exercises-2"><i class="fa fa-check"></i><b>15.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="explain-queries-71.html"><a href="explain-queries-71.html"><i class="fa fa-check"></i><b>16</b> Explain queries (71)</a><ul>
<li class="chapter" data-level="16.1" data-path="explain-queries-71.html"><a href="explain-queries-71.html#performance-considerations"><i class="fa fa-check"></i><b>16.1</b> Performance considerations</a></li>
<li class="chapter" data-level="16.2" data-path="explain-queries-71.html"><a href="explain-queries-71.html#clean-up-2"><i class="fa fa-check"></i><b>16.2</b> Clean up</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="sql-queries-behind-the-scenes-72.html"><a href="sql-queries-behind-the-scenes-72.html"><i class="fa fa-check"></i><b>17</b> SQL queries behind the scenes (72)</a><ul>
<li class="chapter" data-level="17.1" data-path="sql-queries-behind-the-scenes-72.html"><a href="sql-queries-behind-the-scenes-72.html#sql-execution-steps"><i class="fa fa-check"></i><b>17.1</b> SQL Execution Steps</a></li>
<li class="chapter" data-level="17.2" data-path="sql-queries-behind-the-scenes-72.html"><a href="sql-queries-behind-the-scenes-72.html#passing-values-to-sql-statements"><i class="fa fa-check"></i><b>17.2</b> Passing values to SQL statements</a></li>
<li class="chapter" data-level="17.3" data-path="sql-queries-behind-the-scenes-72.html"><a href="sql-queries-behind-the-scenes-72.html#pass-multiple-sets-of-values-with-dbbind"><i class="fa fa-check"></i><b>17.3</b> Pass multiple sets of values with dbBind():</a></li>
<li class="chapter" data-level="17.4" data-path="sql-queries-behind-the-scenes-72.html"><a href="sql-queries-behind-the-scenes-72.html#clean-up-3"><i class="fa fa-check"></i><b>17.4</b> Clean up</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="writing-to-the-dbms-73.html"><a href="writing-to-the-dbms-73.html"><i class="fa fa-check"></i><b>18</b> Writing to the DBMS (73)</a><ul>
<li class="chapter" data-level="18.1" data-path="writing-to-the-dbms-73.html"><a href="writing-to-the-dbms-73.html#create-a-new-table"><i class="fa fa-check"></i><b>18.1</b> Create a new table</a></li>
<li class="chapter" data-level="18.2" data-path="writing-to-the-dbms-73.html"><a href="writing-to-the-dbms-73.html#modify-an-existing-table"><i class="fa fa-check"></i><b>18.2</b> Modify an existing table</a></li>
<li class="chapter" data-level="18.3" data-path="writing-to-the-dbms-73.html"><a href="writing-to-the-dbms-73.html#remove-table-and-clean-up"><i class="fa fa-check"></i><b>18.3</b> Remove table and Clean up</a></li>
</ul></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="other-resources-89.html"><a href="other-resources-89.html"><i class="fa fa-check"></i><b>A</b> Other resources (89)</a><ul>
<li class="chapter" data-level="A.1" data-path="other-resources-89.html"><a href="other-resources-89.html#editing-this-book"><i class="fa fa-check"></i><b>A.1</b> Editing this book</a></li>
<li class="chapter" data-level="A.2" data-path="other-resources-89.html"><a href="other-resources-89.html#docker-alternatives"><i class="fa fa-check"></i><b>A.2</b> Docker alternatives</a></li>
<li class="chapter" data-level="A.3" data-path="other-resources-89.html"><a href="other-resources-89.html#docker-and-r"><i class="fa fa-check"></i><b>A.3</b> Docker and R</a></li>
<li class="chapter" data-level="A.4" data-path="other-resources-89.html"><a href="other-resources-89.html#documentation-for-docker-and-postgres"><i class="fa fa-check"></i><b>A.4</b> Documentation for Docker and Postgres</a></li>
<li class="chapter" data-level="A.5" data-path="other-resources-89.html"><a href="other-resources-89.html#sql-and-dplyr"><i class="fa fa-check"></i><b>A.5</b> SQL and dplyr</a></li>
<li class="chapter" data-level="A.6" data-path="other-resources-89.html"><a href="other-resources-89.html#more-resources"><i class="fa fa-check"></i><b>A.6</b> More Resources</a></li>
</ul></li>
<li class="chapter" data-level="B" data-path="mapping-your-local-environment-92.html"><a href="mapping-your-local-environment-92.html"><i class="fa fa-check"></i><b>B</b> Mapping your local environment (92)</a><ul>
<li class="chapter" data-level="B.1" data-path="mapping-your-local-environment-92.html"><a href="mapping-your-local-environment-92.html#environment-tools-used-in-this-chapter"><i class="fa fa-check"></i><b>B.1</b> Environment Tools Used in this Chapter</a></li>
<li class="chapter" data-level="B.2" data-path="mapping-your-local-environment-92.html"><a href="mapping-your-local-environment-92.html#communicating-with-docker-applications"><i class="fa fa-check"></i><b>B.2</b> Communicating with Docker Applications</a></li>
</ul></li>
<li class="chapter" data-level="C" data-path="step-at-a-time-docker.html"><a href="step-at-a-time-docker.html"><i class="fa fa-check"></i><b>C</b> Creating the sql-pet Docker container one step at a time (93)</a><ul>
<li class="chapter" data-level="C.1" data-path="step-at-a-time-docker.html"><a href="step-at-a-time-docker.html#overview-1"><i class="fa fa-check"></i><b>C.1</b> Overview</a></li>
<li class="chapter" data-level="C.2" data-path="step-at-a-time-docker.html"><a href="step-at-a-time-docker.html#download-the-dvdrental-backup-file"><i class="fa fa-check"></i><b>C.2</b> Download the <code>dvdrental</code> backup file</a></li>
<li class="chapter" data-level="C.3" data-path="step-at-a-time-docker.html"><a href="step-at-a-time-docker.html#build-the-docker-container"><i class="fa fa-check"></i><b>C.3</b> Build the Docker Container</a></li>
<li class="chapter" data-level="C.4" data-path="step-at-a-time-docker.html"><a href="step-at-a-time-docker.html#create-the-database-and-restore-from-the-backup"><i class="fa fa-check"></i><b>C.4</b> Create the database and restore from the backup</a></li>
<li class="chapter" data-level="C.5" data-path="step-at-a-time-docker.html"><a href="step-at-a-time-docker.html#connect-to-the-database-with-r"><i class="fa fa-check"></i><b>C.5</b> Connect to the database with R</a></li>
<li class="chapter" data-level="C.6" data-path="step-at-a-time-docker.html"><a href="step-at-a-time-docker.html#cleaning-up-1"><i class="fa fa-check"></i><b>C.6</b> Cleaning up</a></li>
</ul></li>
<li class="chapter" data-level="D" data-path="appendix-d-quick-guide-to-sql-94.html"><a href="appendix-d-quick-guide-to-sql-94.html"><i class="fa fa-check"></i><b>D</b> APPENDIX D - Quick Guide to SQL (94)</a><ul>
<li class="chapter" data-level="D.1" data-path="appendix-d-quick-guide-to-sql-94.html"><a href="appendix-d-quick-guide-to-sql-94.html#data-definition-langauge-ddl"><i class="fa fa-check"></i><b>D.1</b> Data Definition Langauge (DDL)</a></li>
<li class="chapter" data-level="D.2" data-path="appendix-d-quick-guide-to-sql-94.html"><a href="appendix-d-quick-guide-to-sql-94.html#data-manipulation-langauge-dml"><i class="fa fa-check"></i><b>D.2</b> Data Manipulation Langauge (DML)</a></li>
<li class="chapter" data-level="D.3" data-path="appendix-d-quick-guide-to-sql-94.html"><a href="appendix-d-quick-guide-to-sql-94.html#data-control-language-dcl"><i class="fa fa-check"></i><b>D.3</b> Data Control Language (DCL)</a></li>
<li class="chapter" data-level="D.4" data-path="appendix-d-quick-guide-to-sql-94.html"><a href="appendix-d-quick-guide-to-sql-94.html#transaction-control-language-tcl"><i class="fa fa-check"></i><b>D.4</b> Transaction Control Language (TCL)</a></li>
</ul></li>
<li class="chapter" data-level="E" data-path="additional-technical-details-for-windows-users-95.html"><a href="additional-technical-details-for-windows-users-95.html"><i class="fa fa-check"></i><b>E</b> Additional technical details for Windows users (95)</a><ul>
<li class="chapter" data-level="E.1" data-path="additional-technical-details-for-windows-users-95.html"><a href="additional-technical-details-for-windows-users-95.html#hardware-requirements"><i class="fa fa-check"></i><b>E.1</b> Hardware requirements</a></li>
<li class="chapter" data-level="E.2" data-path="additional-technical-details-for-windows-users-95.html"><a href="additional-technical-details-for-windows-users-95.html#software-requirements"><i class="fa fa-check"></i><b>E.2</b> Software requirements</a><ul>
<li class="chapter" data-level="E.2.1" data-path="additional-technical-details-for-windows-users-95.html"><a href="additional-technical-details-for-windows-users-95.html#windows-7-8-8.1-and-windows-10-home-64-bit"><i class="fa fa-check"></i><b>E.2.1</b> Windows 7, 8, 8.1 and Windows 10 Home (64 bit)</a></li>
<li class="chapter" data-level="E.2.2" data-path="additional-technical-details-for-windows-users-95.html"><a href="additional-technical-details-for-windows-users-95.html#windows-10-pro"><i class="fa fa-check"></i><b>E.2.2</b> Windows 10 Pro</a></li>
</ul></li>
<li class="chapter" data-level="E.3" data-path="additional-technical-details-for-windows-users-95.html"><a href="additional-technical-details-for-windows-users-95.html#docker-for-windows-settings"><i class="fa fa-check"></i><b>E.3</b> Docker for Windows settings</a><ul>
<li class="chapter" data-level="E.3.1" data-path="additional-technical-details-for-windows-users-95.html"><a href="additional-technical-details-for-windows-users-95.html#shared-drives"><i class="fa fa-check"></i><b>E.3.1</b> Shared drives</a></li>
<li class="chapter" data-level="E.3.2" data-path="additional-technical-details-for-windows-users-95.html"><a href="additional-technical-details-for-windows-users-95.html#kubernetes"><i class="fa fa-check"></i><b>E.3.2</b> Kubernetes</a></li>
</ul></li>
<li class="chapter" data-level="E.4" data-path="additional-technical-details-for-windows-users-95.html"><a href="additional-technical-details-for-windows-users-95.html#git-github-and-line-endings"><i class="fa fa-check"></i><b>E.4</b> Git, GitHub and line endings</a></li>
</ul></li>
<li class="chapter" data-level="F" data-path="dplyr-functions-and-sql-cross-walk-96.html"><a href="dplyr-functions-and-sql-cross-walk-96.html"><i class="fa fa-check"></i><b>F</b> Dplyr functions and SQL cross-walk (96)</a></li>
<li class="chapter" data-level="G" data-path="dbi-package-functions-coverage-96b.html"><a href="dbi-package-functions-coverage-96b.html"><i class="fa fa-check"></i><b>G</b> DBI package functions - coverage (96b)</a></li>
<li class="chapter" data-level="H" data-path="postgresql-authentication-96c.html"><a href="postgresql-authentication-96c.html"><i class="fa fa-check"></i><b>H</b> PostgreSQL Authentication (96c)</a><ul>
<li class="chapter" data-level="H.1" data-path="postgresql-authentication-96c.html"><a href="postgresql-authentication-96c.html#introduction-1"><i class="fa fa-check"></i><b>H.1</b> Introduction</a></li>
<li class="chapter" data-level="H.2" data-path="postgresql-authentication-96c.html"><a href="postgresql-authentication-96c.html#password-authentication-on-the-postgresql-docker-image"><i class="fa fa-check"></i><b>H.2</b> Password authentication on the PostgreSQL Docker image</a></li>
<li class="chapter" data-level="H.3" data-path="postgresql-authentication-96c.html"><a href="postgresql-authentication-96c.html#adding-roles"><i class="fa fa-check"></i><b>H.3</b> Adding roles</a><ul>
<li class="chapter" data-level="H.3.1" data-path="postgresql-authentication-96c.html"><a href="postgresql-authentication-96c.html#setting-up-docker"><i class="fa fa-check"></i><b>H.3.1</b> Setting up Docker</a></li>
<li class="chapter" data-level="H.3.2" data-path="postgresql-authentication-96c.html"><a href="postgresql-authentication-96c.html#creating-a-new-container"><i class="fa fa-check"></i><b>H.3.2</b> Creating a new container</a></li>
<li class="chapter" data-level="H.3.3" data-path="postgresql-authentication-96c.html"><a href="postgresql-authentication-96c.html#adding-a-role"><i class="fa fa-check"></i><b>H.3.3</b> Adding a role</a></li>
<li class="chapter" data-level="H.3.4" data-path="postgresql-authentication-96c.html"><a href="postgresql-authentication-96c.html#did-it-work"><i class="fa fa-check"></i><b>H.3.4</b> Did it work?</a></li>
<li class="chapter" data-level="H.3.5" data-path="postgresql-authentication-96c.html"><a href="postgresql-authentication-96c.html#remove-the-container"><i class="fa fa-check"></i><b>H.3.5</b> Remove the container</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R, Databases and Docker</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="joins-and-complex-queries-13" class="section level1">
<h1><span class="header-section-number">Chapter 12</span> Joins and complex queries (13)</h1>
<blockquote>
<p>This chapter demonstrates how to:</p>
<ul>
<li>Use primary and foreign keys to retrieve specific rows of a table</li>
<li>do different kinds of join queries</li>
<li>Exercises</li>
<li>Query the database to get basic information about each dvdrental story</li>
<li>How to interact with the database using different strategies</li>
</ul>
</blockquote>
<p>Verify Docker is up and running:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sp_check_that_docker_is_up</span>()</code></pre>
<pre><code>## [1] &quot;Docker is up but running no containers&quot;</code></pre>
<p>Verify pet DB is available, it may be stopped.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sp_show_all_docker_containers</span>()</code></pre>
<pre><code>## CONTAINER ID        IMAGE                COMMAND                  CREATED             STATUS                     PORTS               NAMES
## baf4571ff902        postgres-dvdrental   &quot;docker-entrypoint.s…&quot;   31 seconds ago      Exited (0) 2 seconds ago                       sql-pet</code></pre>
<p>Start up the <code>docker-pet</code> container</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sp_docker_start</span>(<span class="st">&quot;sql-pet&quot;</span>)</code></pre>
<p>Now connect to the database with R</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># need to wait for Docker &amp; Postgres to come up before connecting.</span>

con &lt;-<span class="st"> </span><span class="kw">sp_get_postgres_connection</span>(
  <span class="dt">user =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_USER_NAME&quot;</span>),
  <span class="dt">password =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;DEFAULT_POSTGRES_PASSWORD&quot;</span>),
  <span class="dt">dbname =</span> <span class="st">&quot;dvdrental&quot;</span>,
  <span class="dt">seconds_to_test =</span> <span class="dv">30</span>
)</code></pre>
<div id="database-privileges" class="section level2">
<h2><span class="header-section-number">12.1</span> Database Privileges</h2>
<p>In the DVD rental database, you have all database privileges to perform any CRUD operaion, create, read, update, and delete on any database object. As a data analyst, you typically only get select privilege which allows you to read only a subset of the tables in a database. Occasionally, a proof of concept project may have a sandbox spun up where users are granted additional priviledges.</p>
</div>
<div id="database-constraints" class="section level2">
<h2><span class="header-section-number">12.2</span> Database constraints</h2>
<p>As a data analyst, you really do not need to worry about database constraints since you are primarily writing dplyr/SQL queries to pull data out of the database. Constraints can be enforced at multiple levels: column, table, multiple tables, or at the schema itself. The common database constraints are a column is <code>NOT NULL</code>, a column is <code>UNIQUE</code>, a column is a <code>PRIMARY KEY</code>, both <code>NOT NULL</code> and <code>UNIQUE</code>, or a column is a <code>FOREIGN KEY</code>, the <code>PRIMARY KEY</code> on another table. Constraints restrict column values to a set of defined values and help enforce referential integrity between tables.</p>
<div id="dvd-rental-primary-foreign-key-constraints" class="section level3">
<h3><span class="header-section-number">12.2.1</span> DVD Rental Primary Foreign Key Constraints</h3>
<p>For this tutorial, we are primarily concerned with primary and foreign key relationships between tables in order to correctly join the data between tables. If one looks at all the tables in the DVD Rental ERD, add link here, the first column is the name of the table followed by &quot;_id“. This is the primary key on the table. In some of the tables, there are other columns that begin with the name of a different table, the foreign table, and end in”_id&quot;. These are foreign keys and the foreign key value is the primary key value on the foreign table. The DBA will index the primary and foreign key columns to speed up query performanace.</p>
<p>In the table below, all the primary foreign key relationships are shown because the DVD rental system is small. Real world databases typically have hundreds or thousands of primary foreign key relationships. In the search box, enter ‘PRIMARY’ or ‘FOREIGN’ to see the table primary key or the table’s foreign key relationships.</p>
<div id="htmlwidget-1d9f9b9fdca3023baa83" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1d9f9b9fdca3023baa83">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35"],["actor","address","address","category","city","city","country","customer","customer","film","film","film_actor","film_actor","film_actor","film_actor","film_category","film_category","film_category","film_category","inventory","inventory","language","payment","payment","payment","payment","rental","rental","rental","rental","staff","staff","store","store","store"],["actor_id","address_id","city_id","category_id","city_id","country_id","country_id","customer_id","address_id","film_id","language_id","actor_id","actor_id","film_id","film_id","category_id","film_id","category_id","film_id","film_id","inventory_id","language_id","staff_id","customer_id","rental_id","payment_id","customer_id","rental_id","staff_id","inventory_id","staff_id","address_id","store_id","address_id","manager_staff_id"],["PRIMARY KEY","PRIMARY KEY","FOREIGN KEY","PRIMARY KEY","PRIMARY KEY","FOREIGN KEY","PRIMARY KEY","PRIMARY KEY","FOREIGN KEY","PRIMARY KEY","FOREIGN KEY","FOREIGN KEY","PRIMARY KEY","PRIMARY KEY","FOREIGN KEY","FOREIGN KEY","PRIMARY KEY","PRIMARY KEY","FOREIGN KEY","FOREIGN KEY","PRIMARY KEY","PRIMARY KEY","FOREIGN KEY","FOREIGN KEY","FOREIGN KEY","PRIMARY KEY","FOREIGN KEY","PRIMARY KEY","FOREIGN KEY","FOREIGN KEY","PRIMARY KEY","FOREIGN KEY","PRIMARY KEY","FOREIGN KEY","FOREIGN KEY"],["","","city","","","country","","","address","","language","actor","","","film","category","","","film","film","","","staff","customer","rental","","customer","","staff","inventory","","address","","address","staff"],["","","city_id","","","country_id","","","address_id","","language_id","actor_id","","","film_id","category_id","","","film_id","film_id","","","staff_id","customer_id","rental_id","","customer_id","","staff_id","inventory_id","","address_id","","address_id","staff_id"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>table_name<\/th>\n      <th>column_name<\/th>\n      <th>constraint_type<\/th>\n      <th>ref_table<\/th>\n      <th>ref_table_col<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
<p>Searching for ‘FOREIGN’ in the table above, one sees that the <code>column_name</code> matches the <code>ref_table_col</code>. This is pretty typical, but not always the case. This can occur because of an inconsistent naming convention in the application design or a table contains multiple references to the same table foreign table and each reference indicates a different role. A non-DVD rental example of the latter is a patient transaction record that has a referring doctor and and performing doctor. The two columns will have different names, but may refer to the same or different doctors in the doctor table. In this case you may hear one say that the doctor table is performing two different roles.</p>
</div>
</div>
<div id="making-up-data-for-join-examples" class="section level2">
<h2><span class="header-section-number">12.3</span> Making up data for Join Examples</h2>
<p>Each chapter in the book stands on its own. If you have worked through the code blocks in this chapter in a previous session, you created some new customer records in order to work through material in the rest of the chapter. In the next couple of code blocks, we delete the new data and then recreate the data for the join examples in the next chapter.</p>
<div id="sql-delete-data-syntax" class="section level3">
<h3><span class="header-section-number">12.3.1</span> SQL Delete Data Syntax</h3>
<pre><code>    DELETE FROM &lt;source&gt; WHERE &lt;where_clause&gt;;</code></pre>
</div>
<div id="delete-new-practice-customers-from-the-customer-table." class="section level3">
<h3><span class="header-section-number">12.3.2</span> Delete New Practice Customers from the Customer table.</h3>
<p>In the next code block we delete out the new customers that were added when the book was compliled or added working through the exercises. Out of the box, the DVD rental database’s highest customer_id = 599.</p>
<pre><code>dbExecute() always returns a scalar numeric that specifies the number of rows affected by the statement. </code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dbExecute</span>(
  con,
  <span class="st">&quot;delete from customer </span>
<span class="st">   where customer_id &gt;= 600;</span>
<span class="st">  &quot;</span>
)</code></pre>
<pre><code>## [1] 0</code></pre>
<p>The number above tells us how many rows were actually deleted from the customer table.</p>
</div>
<div id="delete-new-practice-films-from-the-film-table." class="section level3">
<h3><span class="header-section-number">12.3.3</span> Delete New Practice Films from the Film table.</h3>
<p>In the next code block we delete out the new films that were added when the book was compliled or added working through the exercises. Out of the box, the DVD film database’s highest film_id = 1000.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dbExecute</span>(
  con,
  <span class="st">&quot;delete from film</span>
<span class="st">   where film_id &gt; 1000;</span>
<span class="st">  &quot;</span>
)</code></pre>
<pre><code>## [1] 0</code></pre>
</div>
<div id="sql-single-row-insert-data-syntax" class="section level3">
<h3><span class="header-section-number">12.3.4</span> SQL Single Row Insert Data Syntax</h3>
<pre><code>    INSERT INTO &lt;target&gt; &lt;column_list&gt; VALUES &lt;values list&gt;;
    &lt;target&gt; : target table/view
    &lt;column list&gt; : csv list of columns
    &lt;values list&gt; : values assoicated with the column list.</code></pre>
<p>The <code>column list</code> is the list of column names on the table and the corresponding list of values have to have the correct data type. The following code block returns the <code>CUSTOMER</code> column names and data types.</p>
<pre class="sourceCode r"><code class="sourceCode r">customer_cols &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;select table_name, column_name, ordinal_position, data_type </span>
<span class="st">          from information_schema.columns </span>
<span class="st">         where table_catalog = &#39;dvdrental&#39; </span>
<span class="st">           and table_name = &#39;customer&#39;</span>
<span class="st">       ;&quot;</span>
)

<span class="kw">sp_print_df</span>(customer_cols)</code></pre>
<div id="htmlwidget-b18b48ec4ad649442f3b" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-b18b48ec4ad649442f3b">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10"],["customer","customer","customer","customer","customer","customer","customer","customer","customer","customer"],["customer_id","store_id","first_name","last_name","email","address_id","activebool","create_date","last_update","active"],[1,2,3,4,5,6,7,8,9,10],["integer","smallint","character varying","character varying","character varying","smallint","boolean","date","timestamp without time zone","integer"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>table_name<\/th>\n      <th>column_name<\/th>\n      <th>ordinal_position<\/th>\n      <th>data_type<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":3},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>In the next code block, we insert Sophie as a new customer into the customer table via a SQL insert statement. The columns list clause has three id columns, customer_id, store_id, and address_id. The customer_id is a primary key column and the other two ‘look like’ foreign key columns.</p>
<p>For now, we are interested in getting some new customers into the customer table. We look at the relations between the customer table and the store and address tables later in this chapter.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dbExecute</span>(
  con,
  <span class="st">&quot;insert into customer </span>
<span class="st">  (customer_id,store_id,first_name,last_name,email,address_id,activebool</span>
<span class="st">  ,create_date,last_update,active)</span>
<span class="st">  values(600,3,&#39;Sophie&#39;,&#39;Yang&#39;,&#39;sophie.yang@sakilacustomer.org&#39;,1,TRUE,now(),now()::date,1)</span>
<span class="st">  &quot;</span>
)</code></pre>
<pre><code>## [1] 1</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">new_customers &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con, <span class="st">&quot;select * from customer where customer_id &gt;= 600;&quot;</span>)
<span class="kw">sp_print_df</span>(new_customers)</code></pre>
<div id="htmlwidget-514d280a38cf86ead40b" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-514d280a38cf86ead40b">{"x":{"filter":"none","data":[["1"],[600],[3],["Sophie"],["Yang"],["sophie.yang@sakilacustomer.org"],[1],[true],["2018-12-30"],["2018-12-30T08:00:00Z"],[1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>customer_id<\/th>\n      <th>store_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>email<\/th>\n      <th>address_id<\/th>\n      <th>activebool<\/th>\n      <th>create_date<\/th>\n      <th>last_update<\/th>\n      <th>active<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,6,10]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="primary-and-foreign-key-constraint-error-messages" class="section level3">
<h3><span class="header-section-number">12.3.5</span> Primary and Foreign Key Constraint Error Messages</h3>
<p>For the new customers, we are concerned with not violating the PK and FK constraints.</p>
<p>If the customer_id = 600 value is changed to 599, the database throws the following error message.</p>
<pre><code>Error in result_create(conn@ptr, statement) : Failed to fetch row: ERROR: duplicate key value violates unique constraint &quot;customer_pkey&quot; DETAIL: Key (customer_id)=(599) already exists.</code></pre>
<p>If the address_id value = 1 is changed to 611, the database throws the following error message:</p>
<pre><code>Error in result_create(conn@ptr, statement) : Failed to fetch row: ERROR: insert or update on table &quot;customer&quot; violates foreign key constraint &quot;customer_address_id_fkey&quot; DETAIL: Key (address_id)=(611) is not present in table &quot;address&quot;.</code></pre>
</div>
<div id="r-exercise-inserting-a-single-row-via-a-dataframe" class="section level3">
<h3><span class="header-section-number">12.3.6</span> R Exercise: Inserting a Single Row via a Dataframe</h3>
<p>In the following code block replace Sophie Yang with your name where appropriate.<br />
Note:</p>
<ol style="list-style-type: decimal">
<li>The last data frame parameter sets the stringsAsFactors is <code>FALSE</code>. Databases do not have a native <code>FACTOR</code> type.</li>
<li>The dataframe column names must match the table column names.</li>
<li>The dbWriteTable function needs <code>append</code> = true to actually insert the new row.</li>
<li>The dbWriteTable function has an option ‘overwrite’. It is set to FALSE by default. If it is set to TRUE, the table is first truncated.</li>
<li>No write occurs if both overwrite and append = FALSE.</li>
</ol>
<pre class="sourceCode r"><code class="sourceCode r">df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(
  <span class="dt">customer_id =</span> <span class="dv">601</span>
  , <span class="dt">store_id =</span> <span class="dv">2</span>
  , <span class="dt">first_name =</span> <span class="st">&quot;Sophie&quot;</span>
  , <span class="dt">last_name =</span> <span class="st">&quot;Yang&quot;</span>
  , <span class="dt">email =</span> <span class="st">&quot;sophie.yang@sakilacustomer.org&quot;</span>
  , <span class="dt">address_id =</span> <span class="dv">1</span>
  , <span class="dt">activebool =</span> <span class="ot">TRUE</span>
  , <span class="dt">create_date =</span> <span class="kw">Sys.Date</span>()
  , <span class="dt">last_update =</span> <span class="kw">Sys.time</span>()
  , <span class="dt">active =</span> <span class="dv">1</span>
  , <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>
)
<span class="kw">dbWriteTable</span>(con, <span class="st">&quot;customer&quot;</span>, <span class="dt">value =</span> df, <span class="dt">append =</span> <span class="ot">TRUE</span>, <span class="dt">row.names =</span> <span class="ot">FALSE</span>)

new_customers &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con, <span class="st">&quot;select * from customer where customer_id &gt;= 600;&quot;</span>)
<span class="kw">sp_print_df</span>(new_customers)</code></pre>
<div id="htmlwidget-74434d812ec23342fdce" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-74434d812ec23342fdce">{"x":{"filter":"none","data":[["1","2"],[600,601],[3,2],["Sophie","Sophie"],["Yang","Yang"],["sophie.yang@sakilacustomer.org","sophie.yang@sakilacustomer.org"],[1,1],[true,true],["2018-12-30","2018-12-29"],["2018-12-30T08:00:00Z","2018-12-30T00:45:09Z"],[1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>customer_id<\/th>\n      <th>store_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>email<\/th>\n      <th>address_id<\/th>\n      <th>activebool<\/th>\n      <th>create_date<\/th>\n      <th>last_update<\/th>\n      <th>active<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,6,10]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="sql-multi-row-insert-data-syntax" class="section level2">
<h2><span class="header-section-number">12.4</span> SQL Multi-Row Insert Data Syntax</h2>
<pre><code>    INSERT INTO &lt;target&gt; &lt;column_list&gt; VALUES &lt;values list1&gt;, ... &lt;values listn&gt;;
    &lt;target&gt; : target table/view
    &lt;column list&gt; : csv list of columns
    &lt;values list&gt; : values assoicated with the column list.</code></pre>
<p>Postgres and some other flavors of SQL allow multiple rows to be inserted at a time. The syntax is identical to the Single Row syntax, but includes multiple <code>&lt;values list&gt;</code> clauses separated by commas. The following code block illustrates the SQL multi-row insert. Note that the customer_id column takes on sequential values to satisfy the PK constraint.</p>
</div>
<div id="sql-multi-row-insert-data-example" class="section level2">
<h2><span class="header-section-number">12.5</span> SQL Multi-Row Insert Data Example</h2>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co">#</span>
<span class="kw">dbExecute</span>(
  con,
  <span class="st">&quot;insert into customer </span>
<span class="st">  (customer_id,store_id,first_name,last_name,email,address_id,activebool</span>
<span class="st">  ,create_date,last_update,active)</span>
<span class="st">   values(602,1,&#39;John&#39;,&#39;Smith&#39;,&#39;john.smith@sakilacustomer.org&#39;,2,TRUE</span>
<span class="st">         ,now()::date,now()::date,1)</span>
<span class="st">         ,(603,1,&#39;Ian&#39;,&#39;Frantz&#39;,&#39;ian.frantz@sakilacustomer.org&#39;,3,TRUE</span>
<span class="st">         ,now()::date,now()::date,1)</span>
<span class="st">         ,(604,1,&#39;Ed&#39;,&#39;Borasky&#39;,&#39;ed.borasky@sakilacustomer.org&#39;,4,TRUE</span>
<span class="st">         ,now()::date,now()::date,1)</span>
<span class="st">         ;&quot;</span>
)</code></pre>
<pre><code>## [1] 3</code></pre>
<p>The Postgres R multi-row insert is similar to the single row insert. The single column values are converted to a vector of values.</p>
<div id="r-exercise-inserting-multiple-rows-via-a-dataframe" class="section level3">
<h3><span class="header-section-number">12.5.1</span> R Exercise: Inserting Multiple Rows via a Dataframe</h3>
<p>Replace the two first_name, last_name, and email column values with your own made up values.</p>
<pre class="sourceCode r"><code class="sourceCode r">customer_id &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">605</span>, <span class="dv">606</span>)
store_id &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>)
first_name &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;John&quot;</span>, <span class="st">&quot;Ian&quot;</span>)
last_name &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Smith&quot;</span>, <span class="st">&quot;Frantz&quot;</span>)
email &lt;-<span class="st"> </span><span class="kw">c</span>(
  <span class="st">&quot;john.smith@sakilacustomer.org&quot;</span>, <span class="st">&quot;ian.frantz@sakilacustomer.org&quot;</span>
)
address_id &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>)
activebool &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="ot">TRUE</span>, <span class="ot">TRUE</span>)
create_date &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">Sys.Date</span>(), <span class="kw">Sys.Date</span>())
last_update &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">Sys.time</span>(), <span class="kw">Sys.time</span>())
active &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>)

df2 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(customer_id, store_id, first_name, last_name, email,
  address_id, activebool, create_date, last_update, active,
  <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>
)


<span class="kw">dbWriteTable</span>(con, <span class="st">&quot;customer&quot;</span>,
  <span class="dt">value =</span> df2, <span class="dt">append =</span> <span class="ot">TRUE</span>, <span class="dt">row.names =</span> <span class="ot">FALSE</span>
)

new_customers &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con, <span class="st">&quot;select * from customer where customer_id &gt;= 600;&quot;</span>)
<span class="kw">sp_print_df</span>(new_customers)</code></pre>
<div id="htmlwidget-8da54f9f5480ad7c3ec3" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-8da54f9f5480ad7c3ec3">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7"],[600,601,602,603,604,605,606],[3,2,1,1,1,3,4],["Sophie","Sophie","John","Ian","Ed","John","Ian"],["Yang","Yang","Smith","Frantz","Borasky","Smith","Frantz"],["sophie.yang@sakilacustomer.org","sophie.yang@sakilacustomer.org","john.smith@sakilacustomer.org","ian.frantz@sakilacustomer.org","ed.borasky@sakilacustomer.org","john.smith@sakilacustomer.org","ian.frantz@sakilacustomer.org"],[1,1,2,3,4,3,4],[true,true,true,true,true,true,true],["2018-12-30","2018-12-29","2018-12-30","2018-12-30","2018-12-30","2018-12-29","2018-12-29"],["2018-12-30T08:00:00Z","2018-12-30T00:45:09Z","2018-12-30T08:00:00Z","2018-12-30T08:00:00Z","2018-12-30T08:00:00Z","2018-12-30T00:45:09Z","2018-12-30T00:45:09Z"],[1,1,1,1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>customer_id<\/th>\n      <th>store_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>email<\/th>\n      <th>address_id<\/th>\n      <th>activebool<\/th>\n      <th>create_date<\/th>\n      <th>last_update<\/th>\n      <th>active<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,6,10]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>The <code>film</code> table has a primary key, film_id, and a foreign key column, language_id. In the next code bloock we see five sample rows from the film table.</p>
<pre class="sourceCode r"><code class="sourceCode r">films &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;select film_id,title, language_id</span>
<span class="st">          from film </span>
<span class="st">        order by film_id</span>
<span class="st">        limit 5</span>
<span class="st">       ;&quot;</span>
)

<span class="kw">sp_print_df</span>(films)</code></pre>
<div id="htmlwidget-124fb78127817ec02cd9" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-124fb78127817ec02cd9">{"x":{"filter":"none","data":[["1","2","3","4","5"],[1,2,3,4,5],["Academy Dinosaur","Ace Goldfinger","Adaptation Holes","Affair Prejudice","African Egg"],[1,1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>language_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>The next code block shows all the rows in the language table.</p>
<pre class="sourceCode r"><code class="sourceCode r">languages &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;select language_id, name, last_update from language</span>
<span class="st">       ;&quot;</span>
)

<span class="kw">sp_print_df</span>(languages)</code></pre>
<div id="htmlwidget-dd0a51033db44e820d90" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-dd0a51033db44e820d90">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],[1,2,3,4,5,6],["English             ","Italian             ","Japanese            ","Mandarin            ","French              ","German              "],["2006-02-15T18:02:19Z","2006-02-15T18:02:19Z","2006-02-15T18:02:19Z","2006-02-15T18:02:19Z","2006-02-15T18:02:19Z","2006-02-15T18:02:19Z"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>language_id<\/th>\n      <th>name<\/th>\n      <th>last_update<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":1},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>One cannot insert/update a row into the <code>film</code> table with a language_id = 10 because of a constraint on the language_id column. The language_id value must already exist in the <code>language</code> table, values 1 - 6, before the database will allow the new row to be inserted into the table.</p>
</div>
</div>
<div id="messy-data" class="section level2">
<h2><span class="header-section-number">12.6</span> Messy Data</h2>
<p>The data in the DVD rental system is too clean to show some of the issues one comes across in the real world. In the following <code>xxxx</code> code blocks, we look at one row in the film table where the film_id = 1. We first reinitialize language_id to 1 and display the row.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dbExecute</span>(con, <span class="st">&quot;update film set language_id = 1 where film_id = 1;&quot;</span>)</code></pre>
<pre><code>## [1] 1</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dbGetQuery</span>(con, <span class="st">&quot;select &#39;1. Update language_id = 1 successful&#39; step</span>
<span class="st">                        ,film_id, language_id</span>
<span class="st">                   from film where film_id = 1;&quot;</span>)</code></pre>
<pre><code>##                                   step film_id language_id
## 1 1. Update language_id = 1 successful       1           1</code></pre>
<p>The following code block is an example of a SQL anonymous code block that gracefully handles the exception error when we try and update the row with language_id = 10. Note that the language_id is still 1.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dbExecute</span>(con, <span class="st">&quot;</span>
<span class="st">do $$</span>
<span class="st">DECLARE v_id INTEGER;</span>
<span class="st">begin</span>
<span class="st">    v_id = 10;</span>
<span class="st">    update film set language_id = v_id where film_id = 1;</span>
<span class="st">exception</span>
<span class="st">when foreign_key_violation then</span>
<span class="st">    raise notice &#39;SQLERRM = %, language_id = %&#39;, SQLERRM, v_id;</span>
<span class="st">when others then</span>
<span class="st">    raise notice &#39;SQLERRM = % SQLSTATE =%&#39;, SQLERRM, SQLSTATE;</span>
<span class="st">end;</span>
<span class="st">$$ language &#39;plpgsql&#39;;&quot;</span>)</code></pre>
<pre><code>## [1] 0</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dbGetQuery</span>(con, <span class="st">&quot;select &#39;2. Update language_id = 10 failed&#39; step</span>
<span class="st">                        ,film_id, language_id</span>
<span class="st">                   from film where film_id = 1;&quot;</span>)</code></pre>
<pre><code>##                                step film_id language_id
## 1 2. Update language_id = 10 failed       1           1</code></pre>
<div id="messing-up-the-row" class="section level3">
<h3><span class="header-section-number">12.6.1</span> Messing up the row</h3>
<p>The following code block</p>
<ol style="list-style-type: decimal">
<li>disables all the database constraints on the <code>film</code> table</li>
<li>Updates the row with language_id = 10.</li>
<li>Re-enabes the database constraints on the film table</li>
</ol>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co">#</span>
<span class="kw">dbExecute</span>(con, <span class="st">&quot;ALTER TABLE film DISABLE TRIGGER ALL;&quot;</span>)</code></pre>
<pre><code>## [1] 0</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">count &lt;-<span class="st"> </span><span class="kw">dbExecute</span>(con, <span class="st">&quot;update film set language_id = 10 where film_id = 1;&quot;</span>)</code></pre>
<p>While the <code>film</code> table constraints are disabled, we will insert a new film with a language_id = 10.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dbExecute</span>(
  con,
  <span class="st">&quot;insert into film</span>
<span class="st">  (film_id,title,description,release_year,language_id</span>
<span class="st">  ,rental_duration,rental_rate,length,replacement_cost,rating</span>
<span class="st">   ,last_update,special_features,fulltext)</span>
<span class="st">  values(1001,&#39;Sophie&#39;&#39;s Choice&#39;,&#39;orphaned language_id=10&#39;,2018,10</span>
<span class="st">        ,7,4.99,120,14.99,&#39;PG&#39;</span>
<span class="st">        ,now()::date,&#39;{Trailers}&#39;,&#39;&#39;)</span>
<span class="st">  ;</span>
<span class="st">  &quot;</span>
)</code></pre>
<pre><code>## [1] 1</code></pre>
<p>In the following code block we re-enable the <code>film</code> table constraints and confirm that the new record exists.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dbExecute</span>(con, <span class="st">&quot;ALTER TABLE film ENABLE TRIGGER ALL;&quot;</span>)</code></pre>
<pre><code>## [1] 0</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;select film_id,title,description,language_id from film where film_id = 1001;&quot;</span>
)</code></pre>
<pre><code>##   film_id           title             description language_id
## 1    1001 Sophie&#39;s Choice orphaned language_id=10          10</code></pre>
</div>
</div>
<div id="joins" class="section level2">
<h2><span class="header-section-number">12.7</span> Joins</h2>
<p>In section ‘SQL Quick Start Simple Retrieval’, there is a brief discussion of databases and 3NF. One of the goals of normalization is to eliminate redundant data being kept in multiple tables and having each table contain a very granular level of detail. If a record then needs to be updated, it is updated in one table instead of multiple tables improving overall system performance. This also helps simplify and maintain referential integerity between tables.</p>
<p>Bill Kent famously summarized 3NF as every non-key column “must provide a fact about the key,the whole key, and nothing but the key, so help me Codd.”</p>
<p>Normalization breaks data down and JOINs denormalizes the data and builds it back up. The tables are typically related via a primary key - foreign key relationship. The Postgres database enforces the primary and foreign key constraints in the DVD rental database.</p>
<div id="join-types" class="section level3">
<h3><span class="header-section-number">12.7.1</span> Join Types</h3>
<div class="figure">
<img src="screenshots/SQL_JOIN_TYPES.PNG" alt="SQL_JOIN_TYPES" />
<p class="caption">SQL_JOIN_TYPES</p>
</div>
<p>The above diagram can be found <a href="https://way2tutorial.com/sql/sql_join_types_visual_venn_diagram.php">here</a> There are additional graphics at the link, but the explanations are poorly worded and hard to follow.</p>
<p>The diagram above shows nicely the hierarchy of different types of joins. For this tutorial, we can think of joins as either an Inner Join or an Outer Join.</p>
<p>Instead of showing standard Venn diagrams showing the different JOINS, we use an analogy. For those interested though, the typical Venn diagrams can be found <a href="http://www.sql-join.com/sql-join-types/">here</a>.</p>
</div>
<div id="valentines-party" class="section level3">
<h3><span class="header-section-number">12.7.2</span> Valentines Party</h3>
<p>Imagine you are at a large costume Valentine’s Day dance party. The hostess of the party, a data scientist, would like to learn more about the people attending her party. When the band takes a break, she lets everyone know it is time for the judges to evaluate the winners for best costumes and associated prizes.</p>
<div class="figure">
<img src="screenshots/ValentinesDay.PNG" alt="ValentinesDay" />
<p class="caption">ValentinesDay</p>
</div>
<p>She requests the following:</p>
<ol style="list-style-type: decimal">
<li><p>All the couples at the party line up in front of her in a single line with the men on her left and the women on her right, (inner join)</p></li>
<li><p>All the remaining men to form a second line two feet behind the married men, (left outer join, all couples + unattached men)</p></li>
<li><p>All the remaining women to form a third line two feet in front of the married women, (right outer join, all couples + unattached women)</p></li>
</ol>
<p>As our data scientist looks out, she can clearly see the three distinct lines, the single men, the man woman couples, and the single women, a full outer join.</p>
<p>As the three judges start walking down the lines, she makes one more announcement.</p>
<ol start="4" style="list-style-type: decimal">
<li>There is a special prize for the man and woman who can guess the average age of the members of the opposite sex. To give everyone a chance to come up with an average age, she asks the men to stay in line and the women to move down the mens line in order circling back around until they get back to their starting point in line, (cartesian join, every man seen by every woman and vice versa).</li>
</ol>
<p>It is hard enough to tell someone’s age when they don’t have a mask, how do you get the average age when people have masks?</p>
<p>The hostess knows that there is usually some data anomolies. As she looks out she sees a small cluster of people who did not line up. Being the hostess with the mostest, she wants to get to know that small cluster better. Since they are far off and in costume, she cannot tell if they are men or women. More importantly, she does not know if they identify as a man or a woman, both – (kind of a stretch for a self join), neither, or something else. Ahh, the inquisitive mind wants to know.</p>
</div>
<div id="join-syntax" class="section level3">
<h3><span class="header-section-number">12.7.3</span> Join Syntax</h3>
<p>The table below shows the two R join function call formats, standalone function call and pipe function call and the corresponding SQL join format.</p>
<table>
<colgroup>
<col width="3%" />
<col width="57%" />
<col width="38%" />
</colgroup>
<thead>
<tr class="header">
<th>Join</th>
<th>dplyr</th>
<th>sql</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>inner</td>
<td>inner_join(customer_tbl, rental_tbl, by = ‘customer_id’, suffix = c(“.c”, “.r”))</td>
<td>from customer c join rental r on c.customer_id = r.customer_id</td>
</tr>
<tr class="even">
<td></td>
<td>customer_tbl %&gt;% inner_join(rental_tbl, by = ‘customer_id’, suffix = c(“.c”, “.r”))</td>
<td></td>
</tr>
<tr class="odd">
<td>left</td>
<td>left_join(customer_tbl, rental_tbl, by = ‘customer_id’, suffix = c(“.c”, “.r”))</td>
<td>from customer c left outer join rental r on c.customer_id = r.customer_id</td>
</tr>
<tr class="even">
<td></td>
<td>customer_tbl %&gt;% left_join(rental_tbl, by = ‘customer_id’, suffix = c(“.c”, “.r”))</td>
<td></td>
</tr>
<tr class="odd">
<td>right</td>
<td>right_join(customer_tbl, rental_tbl, by = ‘customer_id’, suffix = c(“.c”, “.r”))</td>
<td>from customer c right outer join rental r on c.customer_id = r.customer_id</td>
</tr>
<tr class="even">
<td></td>
<td>customer_tbl %&gt;% right_join(rental_tbl, by = ‘customer_id’, suffix = c(“.c”, “.r”))</td>
<td></td>
</tr>
<tr class="odd">
<td>full</td>
<td>full_join(customer_tbl, rental_tbl, by = ‘customer_id’, suffix = c(“.c”, “.r”))</td>
<td>from customer c full outer join rental r on c.customer_id = r.customer_id</td>
</tr>
<tr class="even">
<td></td>
<td>customer_tbl %&gt;% full_join(rental_tbl, by = ‘customer_id’, suffix = c(“.c”, “.r”))</td>
<td></td>
</tr>
</tbody>
</table>
</div>
<div id="join-tables" class="section level3">
<h3><span class="header-section-number">12.7.4</span> Join Tables</h3>
<p>The dplyr join documentation describes two different types of joins, <code>mutating</code> and <code>filtering</code> joins. For those coming to R with a SQL background, the mutating documentation is misleading in one respect. Here is the inner_join documentation.</p>
<pre><code>    inner_join()
    
    return all rows from x where there are matching values in y, and all columns from x and y. If there are multiple matches between x and y, all combination of the matches are returned.</code></pre>
<p>The misleading part is that all the columns from <em>x</em> and <em>y</em>. If the join column is <code>KEY</code>, SQL will return x.KEY and y.KEY. Dplyr retuns KEY. It appears that the KEY value comes from the driving table. This difference should become clear in the outer join examples.</p>
<p>In the next couple of examples, we will pull all the language and <code>film</code> table data from the database into memory because the tables are small. In the *_join verbs, the <code>by</code> and <code>suffix</code> parameters are included because it helps document the actual join and the source of join columns.</p>
</div>
</div>
<div id="natural-join-delayed-time-bomb" class="section level2">
<h2><span class="header-section-number">12.8</span> Natural Join Delayed Time Bomb</h2>
<p>The dplyr default join is a natural join, joining tables on common column names. One of many links why one should not use natural joins can be found <a href="http://gplivna.blogspot.com/2007/10/natural-joins-are-evil-motto-if-you.html">here</a>. If two tables are joined via a natural join on column <code>C1</code> the join continues to work as long as no additional common columns are added to either table. If a new new column <code>C2</code> is added to one of the tables and <code>C2</code> already exists in the other table, BOOM, the delayed time bomb goes off. The natural join still executes, doesn’t throw any errors, but the returned result set may be smaller, much smaller, than before the new <code>C2</code> column was added.<br />
### SQL Language_id Distribution</p>
<p>The next code block calculates the <code>language_id</code> distribution in the <code>film</code> and <code>language</code> tables. The results will be used in following sections to validate different join result sets.</p>
<pre class="sourceCode r"><code class="sourceCode r">lang_distribution_sql &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con
          ,<span class="st">&quot;select &#39;film&#39; tbl,language_id,count(*) count </span>
<span class="st">              from film group by language_id</span>
<span class="st">            union</span>
<span class="st">            select &#39;language&#39; tbl,language_id,count(*) count </span>
<span class="st">              from language group by language_id</span>
<span class="st">            order by tbl,language_id;&quot;</span>
          )
<span class="kw">sp_print_df</span>(lang_distribution_sql)</code></pre>
<div id="htmlwidget-1fe403c81784621152ab" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1fe403c81784621152ab">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8"],["film","film","language","language","language","language","language","language"],[1,10,1,2,3,4,5,6],[999,2,1,1,1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>tbl<\/th>\n      <th>language_id<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div id="dplyr-language-distribution-exercise" class="section level3">
<h3><span class="header-section-number">12.8.1</span> dplyr language distribution Exercise</h3>
<p>Execute and Review the output from the code block below. Union and arrange the output to match the SQL output in the previous code block.</p>
<pre class="sourceCode r"><code class="sourceCode r">language_table &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbReadTable</span>(con, <span class="st">&quot;language&quot;</span>)
film_table &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbReadTable</span>(con, <span class="st">&quot;film&quot;</span>)

language_summary &lt;-<span class="st"> </span>language_table <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(language_id) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">count=</span><span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">table=</span><span class="st">&#39;language&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(table,language_id,count)

film_summary &lt;-<span class="st"> </span>film_table <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(language_id) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">count=</span><span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">table=</span><span class="st">&#39;film&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(table,language_id,count)

<span class="kw">sp_print_df</span>(language_summary)</code></pre>
<div id="htmlwidget-ed78248b32e6634f28e5" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-ed78248b32e6634f28e5">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],["language","language","language","language","language","language"],[1,2,3,4,5,6],[1,1,1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>table<\/th>\n      <th>language_id<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sp_print_df</span>(film_summary)</code></pre>
<div id="htmlwidget-2ae622211a824c064fbd" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-2ae622211a824c064fbd">{"x":{"filter":"none","data":[["1","2"],["film","film"],[1,10],[999,2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>table<\/th>\n      <th>language_id<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co">## UNION the two summary tables and ARRANGE the output to match the SQL output from the previouse code block</span></code></pre>
</div>
</div>
<div id="join-templates" class="section level2">
<h2><span class="header-section-number">12.9</span> Join Templates</h2>
<p>In this section we perform various joins using dplyr and SQL. Each dplyr code block has three purposes.</p>
<ol style="list-style-type: decimal">
<li>Show a working join example.<br />
</li>
<li>The code blocks can be used as templates for beginning more complex dplyr pipes.</li>
<li>The code blocks show the number of joins performed.</li>
</ol>
<p>In these examples, the join condition, the <code>by</code> parameter,</p>
<pre><code>by = c(&#39;language_id&#39;,&#39;language_id&#39;)</code></pre>
<p>the two columns are the same.</p>
<pre><code>In multi-column joins, each language_id would be replaced with a vector of column names used in the join by position.  Note the column names do not need to be identical by position.</code></pre>
<p>The suffix parameter is a way to distinguish the same column name in the joined tables. The suffixes are usually an single letter to represent the name of the table.</p>
<div id="dplyr-inner-join-template" class="section level3">
<h3><span class="header-section-number">12.9.1</span> dplyr Inner Join Template</h3>
<p>For an inner join between two tables, it doesn’t matter which table is on the left, the first table, and which is on the right, the second table, because join conditions on both tables must be satisfied.</p>
<pre class="sourceCode r"><code class="sourceCode r">languages_ij &lt;-<span class="st"> </span>language_table <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">inner_join</span>(film_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;language_id&quot;</span> =<span class="st"> &quot;language_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.l&quot;</span>, <span class="st">&quot;.f&quot;</span>))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(language_id, name) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">inner_joins =</span> <span class="kw">n</span>())

<span class="kw">sp_print_df</span>(languages_ij)</code></pre>
<div id="htmlwidget-09904734225327216f09" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-09904734225327216f09">{"x":{"filter":"none","data":[["1"],[1],["English             "],[999]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>language_id<\/th>\n      <th>name<\/th>\n      <th>inner_joins<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div id="sql-inner-join" class="section level4">
<h4><span class="header-section-number">12.9.1.1</span> SQL Inner Join</h4>
<p>The <code>dplyr</code> suffix is similar to the SQL table. In the previous code block, <code>.l</code> and <code>.f</code> were used in the <code>inner_join</code> suffix parameter. <code>l.</code> and <code>f.</code> are used as aliases in the SQL version below. The role of the dplyr suffix and the SQL alias is to disambiguate duplicate table and column names referenced.</p>
<pre class="sourceCode r"><code class="sourceCode r">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;select l.language_id,l.name,count(*) n</span>
<span class="st">   from language l join film f on l.language_id = f.language_id</span>
<span class="st">  group by l.language_id,l.name;&quot;</span>
)

<span class="kw">sp_print_df</span>(rs)</code></pre>
<div id="htmlwidget-b619f31f38e9f2471fcc" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-b619f31f38e9f2471fcc">{"x":{"filter":"none","data":[["1"],[1],["English             "],[999]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>language_id<\/th>\n      <th>name<\/th>\n      <th>n<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>The output tells us that there are 0 inner joins occurred between the language_table and the film_table.</p>
</div>
</div>
<div id="dplyr-left-outer-join-template" class="section level3">
<h3><span class="header-section-number">12.9.2</span> dplyr Left Outer Join Template</h3>
<p>For a left outer join between two tables, it does matter which table is on the left, the first table, and which is on the right, the second table, because every row in the left table that satsifies the filter/where conditions are returned. The second table returns rows if the join condition is met or returns a row of all null column values.</p>
<pre class="sourceCode r"><code class="sourceCode r">languages_loj &lt;-<span class="st"> </span>language_table <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(film_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;language_id&quot;</span>, <span class="st">&quot;language_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.l&quot;</span>, <span class="st">&quot;.f&quot;</span>))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">join_type =</span>
      <span class="st">&quot;loj&quot;</span>, <span class="dt">film_lang_id =</span> <span class="kw">if_else</span>(<span class="kw">is.na</span>(film_id), film_id, language_id)
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(join_type, language_id, name, film_lang_id) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">lojs =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(join_type, language_id, film_lang_id, name, lojs)
<span class="kw">print</span>(languages_loj)</code></pre>
<pre><code>## # A tibble: 6 x 5
## # Groups:   join_type, language_id, name [6]
##   join_type language_id film_lang_id name                    lojs
##   &lt;chr&gt;           &lt;int&gt;        &lt;int&gt; &lt;chr&gt;                  &lt;int&gt;
## 1 loj                 1            1 &quot;English             &quot;   999
## 2 loj                 2           NA &quot;Italian             &quot;     1
## 3 loj                 3           NA &quot;Japanese            &quot;     1
## 4 loj                 4           NA &quot;Mandarin            &quot;     1
## 5 loj                 5           NA &quot;French              &quot;     1
## 6 loj                 6           NA &quot;German              &quot;     1</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># View(languages_loj)  # &#39;View&#39; causes problems with building the book.  Please comment out after using</span>
<span class="kw">sp_print_df</span>(languages_loj)</code></pre>
<div id="htmlwidget-beeafef17c4840807f51" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-beeafef17c4840807f51">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],["loj","loj","loj","loj","loj","loj"],[1,2,3,4,5,6],[1,null,null,null,null,null],["English             ","Italian             ","Japanese            ","Mandarin            ","French              ","German              "],[999,1,1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>language_id<\/th>\n      <th>film_lang_id<\/th>\n      <th>name<\/th>\n      <th>lojs<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>Compare the mutate verb in the above code block with film_lang_id in the equivalent SQL code block below.</p>
<div id="sql-left-outer-join" class="section level4">
<h4><span class="header-section-number">12.9.2.1</span> SQL Left Outer Join</h4>
<pre class="sourceCode r"><code class="sourceCode r">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;select l.language_id</span>
<span class="st">       ,f.language_id film_lang_id</span>
<span class="st">       ,trim(l.name) as name</span>
<span class="st">       ,count(*) lojs</span>
<span class="st">   from language l left outer join film f </span>
<span class="st">        on l.language_id = f.language_id</span>
<span class="st">  group by l.language_id,l.name,f.language_id</span>
<span class="st">order by l.language_id;&quot;</span>
)
<span class="kw">sp_print_df</span>(rs)</code></pre>
<div id="htmlwidget-f6a2206cea77e899a1de" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-f6a2206cea77e899a1de">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],[1,2,3,4,5,6],[1,null,null,null,null,null],["English","Italian","Japanese","Mandarin","French","German"],[999,1,1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>language_id<\/th>\n      <th>film_lang_id<\/th>\n      <th>name<\/th>\n      <th>lojs<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># rs</span></code></pre>
<p>The lojs column returns the number of rows found on the keys from the left table, language, and the right table, the film table. For the “English” row, the language_id and film_lang_id match and 0 inner joins were performed. For all the other languages, there was only 1 join and they all came from the left outer table, the language table, language_id’s 2 - 6. The right table, the film table returned NA, because no match was found.</p>
<ol style="list-style-type: decimal">
<li>The left outer join always returns all rows from the left table, the driving/key table, if not reduced via a filter()/where clause.<br />
</li>
<li>All rows that inner join returns all the columns/derived columns specified in the select clause from both the left and right tables.<br />
</li>
<li>All rows from the left table, the outer table, without a matching row on the right returns all the columns/derived column values specified in the select clause from the left, but the values from right table have all values of NA.</li>
</ol>
</div>
<div id="dplyr-right-outer-join" class="section level4">
<h4><span class="header-section-number">12.9.2.2</span> dplyr Right Outer Join</h4>
<pre class="sourceCode r"><code class="sourceCode r">languages_roj &lt;-<span class="st"> </span>language_table <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">right_join</span>(film_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;language_id&quot;</span>, <span class="st">&quot;language_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.l&quot;</span>, <span class="st">&quot;.f&quot;</span>)), <span class="dt">all =</span> film_table) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">lang_id =</span>
      <span class="kw">if_else</span>(<span class="kw">is.na</span>(name), 0L, language_id), <span class="dt">join_type =</span> <span class="st">&quot;rojs&quot;</span>
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(join_type, language_id, name, lang_id) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">rojs =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(join_type, lang_id, language_id, name, rojs)

<span class="kw">sp_print_df</span>(languages_roj)</code></pre>
<div id="htmlwidget-80fb537b5ba0bd90fb93" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-80fb537b5ba0bd90fb93">{"x":{"filter":"none","data":[["1","2"],["rojs","rojs"],[1,0],[1,10],["English             ",null],[999,2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>lang_id<\/th>\n      <th>language_id<\/th>\n      <th>name<\/th>\n      <th>rojs<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<pre class="sourceCode r"><code class="sourceCode r">languages_roj</code></pre>
<pre><code>## # A tibble: 2 x 5
## # Groups:   join_type, language_id, name [2]
##   join_type lang_id language_id name                    rojs
##   &lt;chr&gt;       &lt;int&gt;       &lt;int&gt; &lt;chr&gt;                  &lt;int&gt;
## 1 rojs            1           1 &quot;English             &quot;   999
## 2 rojs            0          10 &lt;NA&gt;                       2</code></pre>
<p>Review the mutate above with l.language_id below.</p>
</div>
<div id="sql-right-outer-join" class="section level4">
<h4><span class="header-section-number">12.9.2.3</span> SQL Right Outer Join</h4>
<pre class="sourceCode r"><code class="sourceCode r">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;select &#39;roj&#39; join_type,l.language_id,f.language_id language_id_f,l.name,count(*) rojs</span>
<span class="st">   from language l right outer join film f on l.language_id = f.language_id</span>
<span class="st">  group by l.language_id,l.name,f.language_id</span>
<span class="st">order by l.language_id;&quot;</span>
)
<span class="kw">sp_print_df</span>(rs)</code></pre>
<div id="htmlwidget-703a15d93cfc9aff608e" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-703a15d93cfc9aff608e">{"x":{"filter":"none","data":[["1","2"],["roj","roj"],[1,null],[1,10],["English             ",null],[999,2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>join_type<\/th>\n      <th>language_id<\/th>\n      <th>language_id_f<\/th>\n      <th>name<\/th>\n      <th>rojs<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<pre class="sourceCode r"><code class="sourceCode r">rs</code></pre>
<pre><code>##   join_type language_id language_id_f                 name rojs
## 1       roj           1             1 English               999
## 2       roj          NA            10                 &lt;NA&gt;    2</code></pre>
<p>The rojs column returns the number of rows found on the keys from the right table, film, and the left table, the language table. For the “English” row, the language_id and film_lang_id match and a 1000 inner joins were performed. For language_id = 30 from the right table, there was only 1 join to a non-existant row in the language table on the left.</p>
<ol style="list-style-type: decimal">
<li>The right outer join always returns all rows from the right table, the driving/key table, if not reduced via a filter()/where clause.<br />
</li>
<li>All rows that inner join returns all the columns/derived columns specified in the select clause from both the left and right tables.<br />
</li>
<li>All rows from the right table, the outer table, without a matching row on the left returns all the columns/derived column values specified in the select clause from the right, but the values from left table have all values of NA.</li>
</ol>
</div>
<div id="dplyr-full-outer-join" class="section level4">
<h4><span class="header-section-number">12.9.2.4</span> dplyr Full Outer Join</h4>
<pre class="sourceCode r"><code class="sourceCode r">languages_foj &lt;-<span class="st"> </span>language_table <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">full_join</span>(film_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;language_id&quot;</span>, <span class="st">&quot;language_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.l&quot;</span>, <span class="st">&quot;.f&quot;</span>))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">film_lang =</span> <span class="kw">if_else</span>(<span class="kw">is.na</span>(film_id), <span class="kw">paste0</span>(<span class="st">&quot;No &quot;</span>, name, <span class="st">&quot; films.&quot;</span>), <span class="kw">if_else</span>(<span class="kw">is.na</span>(name), <span class="st">&quot;Alien&quot;</span>, name))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(language_id, name, film_lang) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">n =</span> <span class="kw">n</span>())

<span class="kw">sp_print_df</span>(languages_foj)</code></pre>
<div id="htmlwidget-6d936e3915a36e12cd53" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6d936e3915a36e12cd53">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7"],[1,2,3,4,5,6,10],["English             ","Italian             ","Japanese            ","Mandarin            ","French              ","German              ",null],["English             ","No Italian              films.","No Japanese             films.","No Mandarin             films.","No French               films.","No German               films.","Alien"],[999,1,1,1,1,1,2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>language_id<\/th>\n      <th>name<\/th>\n      <th>film_lang<\/th>\n      <th>n<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<pre class="sourceCode r"><code class="sourceCode r">languages_foj</code></pre>
<pre><code>## # A tibble: 7 x 4
## # Groups:   language_id, name [?]
##   language_id name                   film_lang                          n
##         &lt;int&gt; &lt;chr&gt;                  &lt;chr&gt;                          &lt;int&gt;
## 1           1 &quot;English             &quot; &quot;English             &quot;           999
## 2           2 &quot;Italian             &quot; No Italian              films.     1
## 3           3 &quot;Japanese            &quot; No Japanese             films.     1
## 4           4 &quot;Mandarin            &quot; No Mandarin             films.     1
## 5           5 &quot;French              &quot; No French               films.     1
## 6           6 &quot;German              &quot; No German               films.     1
## 7          10 &lt;NA&gt;                   Alien                              2</code></pre>
</div>
<div id="sql-full-outer-join" class="section level4">
<h4><span class="header-section-number">12.9.2.5</span> SQL full Outer Join</h4>
<pre class="sourceCode r"><code class="sourceCode r">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;select l.language_id,l.name,f.language_id language_id_f,count(*) fojs</span>
<span class="st">   from language l full outer join film f on l.language_id = f.language_id</span>
<span class="st">  group by l.language_id,l.name,f.language_id</span>
<span class="st">order by l.language_id;&quot;</span>
)
<span class="kw">sp_print_df</span>(rs)</code></pre>
<div id="htmlwidget-c195b56d57c26c8f1d4d" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-c195b56d57c26c8f1d4d">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7"],[1,2,3,4,5,6,null],["English             ","Italian             ","Japanese            ","Mandarin            ","French              ","German              ",null],[1,null,null,null,null,null,10],[999,1,1,1,1,1,2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>language_id<\/th>\n      <th>name<\/th>\n      <th>language_id_f<\/th>\n      <th>fojs<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<pre class="sourceCode r"><code class="sourceCode r">rs</code></pre>
<pre><code>##   language_id                 name language_id_f fojs
## 1           1 English                          1  999
## 2           2 Italian                         NA    1
## 3           3 Japanese                        NA    1
## 4           4 Mandarin                        NA    1
## 5           5 French                          NA    1
## 6           6 German                          NA    1
## 7          NA                 &lt;NA&gt;            10    2</code></pre>
<p>Looking at the SQL output, the full outer join is the combination of the left and right outer joins.</p>
<ol style="list-style-type: decimal">
<li>Language_id = 1 is the inner join.</li>
<li>Language_id = 2 - 6 is the left outer join</li>
<li>Language_id = 30 is the right outer join.</li>
</ol>
<p>One can also just look at the language_id on the left and language_id_f on the right for a non NA value to see which side is outer side/driving side of the join.</p>
</div>
<div id="dplyr-anti-join" class="section level4">
<h4><span class="header-section-number">12.9.2.6</span> dplyr anti Join</h4>
<p>The anti join is a left outer join without the inner joined rows. It only returns the rows from the left table that do not have a match from the right table.</p>
<pre class="sourceCode r"><code class="sourceCode r">languages_aj &lt;-<span class="st"> </span>language_table <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">anti_join</span>(film_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;language_id&quot;</span>, <span class="st">&quot;language_id&quot;</span>), <span class="kw">suffix</span>(<span class="kw">c</span>(<span class="st">&quot;.l&quot;</span>, <span class="st">&quot;.f&quot;</span>))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">type =</span> <span class="st">&quot;anti_join&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(type, language_id, name) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">anti_joins =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(type, language_id, name, anti_joins)
<span class="kw">sp_print_df</span>(languages_aj)</code></pre>
<div id="htmlwidget-7a589913f405d7a14fbe" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-7a589913f405d7a14fbe">{"x":{"filter":"none","data":[["1","2","3","4","5"],["anti_join","anti_join","anti_join","anti_join","anti_join"],[2,3,4,5,6],["Italian             ","Japanese            ","Mandarin            ","French              ","German              "],[1,1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>type<\/th>\n      <th>language_id<\/th>\n      <th>name<\/th>\n      <th>anti_joins<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<pre class="sourceCode r"><code class="sourceCode r">languages_aj</code></pre>
<pre><code>## # A tibble: 5 x 4
## # Groups:   type, language_id [5]
##   type      language_id name                   anti_joins
##   &lt;chr&gt;           &lt;int&gt; &lt;chr&gt;                       &lt;int&gt;
## 1 anti_join           2 &quot;Italian             &quot;          1
## 2 anti_join           3 &quot;Japanese            &quot;          1
## 3 anti_join           4 &quot;Mandarin            &quot;          1
## 4 anti_join           5 &quot;French              &quot;          1
## 5 anti_join           6 &quot;German              &quot;          1</code></pre>
</div>
<div id="sql-anti-join-1-left-outer-join-where-null-on-right" class="section level4">
<h4><span class="header-section-number">12.9.2.7</span> SQL anti Join 1, Left Outer Join where NULL on Right</h4>
<p>SQL doesn’t have an anti join key word. Here are three different ways to achieve the same result.</p>
<pre class="sourceCode r"><code class="sourceCode r">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;select l.language_id,l.name,count(*) fojs</span>
<span class="st">   from language l left outer join film f on l.language_id = f.language_id</span>
<span class="st">  where f.language_id is null</span>
<span class="st">  group by l.language_id,l.name</span>
<span class="st">order by l.language_id;&quot;</span>
)
<span class="kw">sp_print_df</span>(rs)</code></pre>
<div id="htmlwidget-a3fe20e2cfd2d5bbfba3" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a3fe20e2cfd2d5bbfba3">{"x":{"filter":"none","data":[["1","2","3","4","5"],[2,3,4,5,6],["Italian             ","Japanese            ","Mandarin            ","French              ","German              "],[1,1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>language_id<\/th>\n      <th>name<\/th>\n      <th>fojs<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<pre class="sourceCode r"><code class="sourceCode r">rs</code></pre>
<pre><code>##   language_id                 name fojs
## 1           2 Italian                 1
## 2           3 Japanese                1
## 3           4 Mandarin                1
## 4           5 French                  1
## 5           6 German                  1</code></pre>
</div>
<div id="sql-anti-join-2-id-in-driving-table-and-not-in-lookup-table" class="section level4">
<h4><span class="header-section-number">12.9.2.8</span> SQL anti Join 2, ID in driving table and NOT IN lookup table</h4>
<pre class="sourceCode r"><code class="sourceCode r">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;select l.language_id,l.name,count(*) fojs</span>
<span class="st">   from language l </span>
<span class="st">  where l.language_id NOT IN (select language_id from film)</span>
<span class="st">  group by l.language_id,l.name</span>
<span class="st">order by l.language_id;&quot;</span>
)
<span class="kw">sp_print_df</span>(rs)</code></pre>
<div id="htmlwidget-a98751c486bb4e6734fc" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a98751c486bb4e6734fc">{"x":{"filter":"none","data":[["1","2","3","4","5"],[2,3,4,5,6],["Italian             ","Japanese            ","Mandarin            ","French              ","German              "],[1,1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>language_id<\/th>\n      <th>name<\/th>\n      <th>fojs<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<pre class="sourceCode r"><code class="sourceCode r">rs</code></pre>
<pre><code>##   language_id                 name fojs
## 1           2 Italian                 1
## 2           3 Japanese                1
## 3           4 Mandarin                1
## 4           5 French                  1
## 5           6 German                  1</code></pre>
</div>
<div id="sql-anti-join-3-not-exists-and-correlated-subquery" class="section level4">
<h4><span class="header-section-number">12.9.2.9</span> SQL anti Join 3, NOT EXISTS and Correlated subquery</h4>
<pre class="sourceCode r"><code class="sourceCode r">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;select l.language_id,l.name,count(*) fojs</span>
<span class="st">   from language l </span>
<span class="st">  where not exists (select language_id from film f where f.language_id = l.language_id)</span>
<span class="st"> group by l.language_id,l.name</span>
<span class="st">&quot;</span>
)
<span class="kw">sp_print_df</span>(rs)</code></pre>
<div id="htmlwidget-90472fc291eea3b37ad9" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-90472fc291eea3b37ad9">{"x":{"filter":"none","data":[["1","2","3","4","5"],[2,3,4,5,6],["Italian             ","Japanese            ","Mandarin            ","French              ","German              "],[1,1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>language_id<\/th>\n      <th>name<\/th>\n      <th>fojs<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<pre class="sourceCode r"><code class="sourceCode r">rs</code></pre>
<pre><code>##   language_id                 name fojs
## 1           2 Italian                 1
## 2           3 Japanese                1
## 3           4 Mandarin                1
## 4           5 French                  1
## 5           6 German                  1</code></pre>
</div>
</div>
</div>
<div id="sql-anti-join-costs" class="section level2">
<h2><span class="header-section-number">12.10</span> SQL anti join Costs</h2>
<pre class="sourceCode r"><code class="sourceCode r">sql_aj1 &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;explain analyze select l.language_id,l.name,count(*) fojs</span>
<span class="st">   from language l left outer join film f on l.language_id = f.language_id</span>
<span class="st">  where f.language_id is null</span>
<span class="st">  group by l.language_id,l.name</span>
<span class="st">&quot;</span>
)

sql_aj2 &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;explain analyze select l.language_id,l.name,count(*) fojs</span>
<span class="st">   from language l </span>
<span class="st">  where l.language_id NOT IN (select language_id from film)</span>
<span class="st">  group by l.language_id,l.name</span>
<span class="st">&quot;</span>
)

sql_aj3 &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;explain analyze select l.language_id,l.name,count(*) fojs</span>
<span class="st">   from language l </span>
<span class="st">  where not exists (select language_id from film f where f.language_id = l.language_id)</span>
<span class="st"> group by l.language_id,l.name</span>
<span class="st">&quot;</span>
)</code></pre>
<div id="sql-costs" class="section level5">
<h5><span class="header-section-number">12.10.0.0.1</span> SQL Costs</h5>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(<span class="kw">glue</span>(<span class="st">&quot;sql_aj1 loj-null costs=&quot;</span>, sql_aj1[<span class="dv">1</span>, <span class="dv">1</span>]))</code></pre>
<pre><code>## sql_aj1 loj-null costs=GroupAggregate  (cost=24.24..24.30 rows=3 width=96) (actual time=0.364..0.467 rows=5 loops=1)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(<span class="kw">glue</span>(<span class="st">&quot;sql_aj2 not in costs=&quot;</span>, sql_aj2[<span class="dv">1</span>, <span class="dv">1</span>]))</code></pre>
<pre><code>## sql_aj2 not in costs=GroupAggregate  (cost=67.60..67.65 rows=3 width=96) (actual time=17.080..17.189 rows=5 loops=1)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(<span class="kw">glue</span>(<span class="st">&quot;sql_aj3 not exist costs=&quot;</span>, sql_aj3[<span class="dv">1</span>, <span class="dv">1</span>]))</code></pre>
<pre><code>## sql_aj3 not exist costs=GroupAggregate  (cost=24.24..24.30 rows=3 width=96) (actual time=0.385..0.494 rows=5 loops=1)</code></pre>
</div>
</div>
<div id="dplyr-anti-joins" class="section level2">
<h2><span class="header-section-number">12.11</span> dplyr Anti joins</h2>
<p>In this next section we look at two methods to implemnt an anti join in dplyr.</p>
<pre class="sourceCode r"><code class="sourceCode r">customer_table &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;customer&quot;</span>) <span class="co"># DBI::dbReadTable(con, &quot;customer&quot;)</span>
rental_table &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;rental&quot;</span>) <span class="co"># DBI::dbReadTable(con, &quot;rental&quot;)</span>

<span class="co"># Method 1.  dplyr anti_join</span>
daj1 &lt;-
<span class="st">  </span><span class="kw">anti_join</span>(customer_table, rental_table, <span class="dt">by =</span> <span class="st">&quot;customer_id&quot;</span>, <span class="dt">suffix =</span> <span class="kw">c</span>(<span class="st">&quot;.c&quot;</span>, <span class="st">&quot;.r&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="kw">c</span>(<span class="st">&quot;first_name&quot;</span>, <span class="st">&quot;last_name&quot;</span>, <span class="st">&quot;email&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">explain</span>()</code></pre>
<pre><code>## &lt;SQL&gt;
## SELECT &quot;first_name&quot;, &quot;last_name&quot;, &quot;email&quot;
## FROM (SELECT * FROM &quot;customer&quot; AS &quot;TBL_LEFT&quot;
## 
## WHERE NOT EXISTS (
##   SELECT 1 FROM &quot;rental&quot; AS &quot;TBL_RIGHT&quot;
##   WHERE (&quot;TBL_LEFT&quot;.&quot;customer_id&quot; = &quot;TBL_RIGHT&quot;.&quot;customer_id&quot;)
## )) &quot;cqpqwqagrn&quot;</code></pre>
<pre><code>## </code></pre>
<pre><code>## &lt;PLAN&gt;
## Hash Anti Join  (cost=510.99..552.63 rows=300 width=334)
##   Hash Cond: (&quot;TBL_LEFT&quot;.customer_id = &quot;TBL_RIGHT&quot;.customer_id)
##   -&gt;  Seq Scan on customer &quot;TBL_LEFT&quot;  (cost=0.00..14.99 rows=599 width=338)
##   -&gt;  Hash  (cost=310.44..310.44 rows=16044 width=2)
##         -&gt;  Seq Scan on rental &quot;TBL_RIGHT&quot;  (cost=0.00..310.44 rows=16044 width=2)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">customer_table &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;customer&quot;</span>) <span class="co"># DBI::dbReadTable(con, &quot;customer&quot;)</span>
rental_table &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;rental&quot;</span>) <span class="co"># DBI::dbReadTable(con, &quot;rental&quot;)</span>

<span class="co"># Method 2.  dplyr loj with NA</span>
daj2 &lt;-
<span class="st">  </span><span class="kw">left_join</span>(customer_table, rental_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;customer_id&quot;</span>, <span class="st">&quot;customer_id&quot;</span>), <span class="dt">suffix =</span> <span class="kw">c</span>(<span class="st">&quot;.c&quot;</span>, <span class="st">&quot;.r&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">is.na</span>(rental_id)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="kw">c</span>(<span class="st">&quot;first_name&quot;</span>, <span class="st">&quot;last_name&quot;</span>, <span class="st">&quot;email&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">explain</span>()</code></pre>
<pre><code>## &lt;SQL&gt;
## SELECT &quot;first_name&quot;, &quot;last_name&quot;, &quot;email&quot;
## FROM (SELECT &quot;TBL_LEFT&quot;.&quot;customer_id&quot; AS &quot;customer_id&quot;, &quot;TBL_LEFT&quot;.&quot;store_id&quot; AS &quot;store_id&quot;, &quot;TBL_LEFT&quot;.&quot;first_name&quot; AS &quot;first_name&quot;, &quot;TBL_LEFT&quot;.&quot;last_name&quot; AS &quot;last_name&quot;, &quot;TBL_LEFT&quot;.&quot;email&quot; AS &quot;email&quot;, &quot;TBL_LEFT&quot;.&quot;address_id&quot; AS &quot;address_id&quot;, &quot;TBL_LEFT&quot;.&quot;activebool&quot; AS &quot;activebool&quot;, &quot;TBL_LEFT&quot;.&quot;create_date&quot; AS &quot;create_date&quot;, &quot;TBL_LEFT&quot;.&quot;last_update&quot; AS &quot;last_update.c&quot;, &quot;TBL_LEFT&quot;.&quot;active&quot; AS &quot;active&quot;, &quot;TBL_RIGHT&quot;.&quot;rental_id&quot; AS &quot;rental_id&quot;, &quot;TBL_RIGHT&quot;.&quot;rental_date&quot; AS &quot;rental_date&quot;, &quot;TBL_RIGHT&quot;.&quot;inventory_id&quot; AS &quot;inventory_id&quot;, &quot;TBL_RIGHT&quot;.&quot;return_date&quot; AS &quot;return_date&quot;, &quot;TBL_RIGHT&quot;.&quot;staff_id&quot; AS &quot;staff_id&quot;, &quot;TBL_RIGHT&quot;.&quot;last_update&quot; AS &quot;last_update.r&quot;
##   FROM &quot;customer&quot; AS &quot;TBL_LEFT&quot;
##   LEFT JOIN &quot;rental&quot; AS &quot;TBL_RIGHT&quot;
##   ON (&quot;TBL_LEFT&quot;.&quot;customer_id&quot; = &quot;TBL_RIGHT&quot;.&quot;customer_id&quot;)
## ) &quot;ihebfvnxvb&quot;
## WHERE (((&quot;rental_id&quot;) IS NULL))</code></pre>
<pre><code>## </code></pre>
<pre><code>## &lt;PLAN&gt;
## Hash Right Join  (cost=22.48..375.33 rows=80 width=334)
##   Hash Cond: (&quot;TBL_RIGHT&quot;.customer_id = &quot;TBL_LEFT&quot;.customer_id)
##   Filter: (&quot;TBL_RIGHT&quot;.rental_id IS NULL)
##   -&gt;  Seq Scan on rental &quot;TBL_RIGHT&quot;  (cost=0.00..310.44 rows=16044 width=6)
##   -&gt;  Hash  (cost=14.99..14.99 rows=599 width=338)
##         -&gt;  Seq Scan on customer &quot;TBL_LEFT&quot;  (cost=0.00..14.99 rows=599 width=338)</code></pre>
<div id="dplyr-costs" class="section level3">
<h3><span class="header-section-number">12.11.1</span> dplyr Costs</h3>
<pre><code>&lt;PLAN&gt;
Hash Anti Join  (cost=510.99..529.72 rows=1 width=45)
  Hash Cond: (&quot;TBL_LEFT&quot;.customer_id = &quot;TBL_RIGHT&quot;.customer_id)
  -&gt;  Seq Scan on customer &quot;TBL_LEFT&quot;  (cost=0.00..14.99 rows=599 width=49)
  -&gt;  Hash  (cost=310.44..310.44 rows=16044 width=2)
        -&gt;  Seq Scan on rental &quot;TBL_RIGHT&quot;  (cost=0.00..310.44 rows=16044 width=2)</code></pre>
<pre><code>&lt;PLAN&gt;
Hash Right Join  (cost=22.48..375.33 rows=1 width=45)
  Hash Cond: (&quot;TBL_RIGHT&quot;.customer_id = &quot;TBL_LEFT&quot;.customer_id)
  Filter: (&quot;TBL_RIGHT&quot;.rental_id IS NULL)
  -&gt;  Seq Scan on rental &quot;TBL_RIGHT&quot;  (cost=0.00..310.44 rows=16044 width=6)
  -&gt;  Hash  (cost=14.99..14.99 rows=599 width=49)
        -&gt;  Seq Scan on customer &quot;TBL_LEFT&quot;  (cost=0.00..14.99 rows=599 width=49)</code></pre>
<p>In this example, the dplyr anti_join verb is <em>1.4113447 to 22.7308719</em> times more expensive than the left outer join with a null condition.</p>
<pre class="sourceCode r"><code class="sourceCode r">sql_aj1 &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;explain analyze select c.customer_id,count(*) lojs</span>
<span class="st">   from customer c left outer join rental r on c.customer_id = r.customer_id</span>
<span class="st">  where r.customer_id is null</span>
<span class="st">  group by c.customer_id</span>
<span class="st">order by c.customer_id;&quot;</span>
)
<span class="kw">sp_print_df</span>(sql_aj1)</code></pre>
<div id="htmlwidget-6c084255227fcd56827e" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6c084255227fcd56827e">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13"],["GroupAggregate  (cost=564.97..570.22 rows=300 width=12) (actual time=252.599..252.770 rows=7 loops=1)","  Group Key: c.customer_id","  -&gt;  Sort  (cost=564.97..565.72 rows=300 width=4) (actual time=252.566..252.621 rows=7 loops=1)","        Sort Key: c.customer_id","        Sort Method: quicksort  Memory: 25kB","        -&gt;  Hash Anti Join  (cost=510.99..552.63 rows=300 width=4) (actual time=252.350..252.500 rows=7 loops=1)","              Hash Cond: (c.customer_id = r.customer_id)","              -&gt;  Seq Scan on customer c  (cost=0.00..14.99 rows=599 width=4) (actual time=0.017..4.318 rows=606 loops=1)","              -&gt;  Hash  (cost=310.44..310.44 rows=16044 width=2) (actual time=243.585..243.591 rows=16044 loops=1)","                    Buckets: 16384  Batches: 1  Memory Usage: 661kB","                    -&gt;  Seq Scan on rental r  (cost=0.00..310.44 rows=16044 width=2) (actual time=0.056..121.488 rows=16044 loops=1)","Planning time: 0.123 ms","Execution time: 252.960 ms"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>QUERY PLAN<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
<pre class="sourceCode r"><code class="sourceCode r">sql_aj1</code></pre>
<pre><code>##                                                                                                                              QUERY PLAN
## 1                                 GroupAggregate  (cost=564.97..570.22 rows=300 width=12) (actual time=252.599..252.770 rows=7 loops=1)
## 2                                                                                                              Group Key: c.customer_id
## 3                                        -&gt;  Sort  (cost=564.97..565.72 rows=300 width=4) (actual time=252.566..252.621 rows=7 loops=1)
## 4                                                                                                               Sort Key: c.customer_id
## 5                                                                                                  Sort Method: quicksort  Memory: 25kB
## 6                              -&gt;  Hash Anti Join  (cost=510.99..552.63 rows=300 width=4) (actual time=252.350..252.500 rows=7 loops=1)
## 7                                                                                            Hash Cond: (c.customer_id = r.customer_id)
## 8                           -&gt;  Seq Scan on customer c  (cost=0.00..14.99 rows=599 width=4) (actual time=0.017..4.318 rows=606 loops=1)
## 9                                  -&gt;  Hash  (cost=310.44..310.44 rows=16044 width=2) (actual time=243.585..243.591 rows=16044 loops=1)
## 10                                                                                      Buckets: 16384  Batches: 1  Memory Usage: 661kB
## 11                     -&gt;  Seq Scan on rental r  (cost=0.00..310.44 rows=16044 width=2) (actual time=0.056..121.488 rows=16044 loops=1)
## 12                                                                                                              Planning time: 0.123 ms
## 13                                                                                                           Execution time: 252.960 ms</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">sql_aj3 &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;explain analyze </span>
<span class="st">select c.customer_id,count(*) lojs</span>
<span class="st">   from customer c </span>
<span class="st">  where not exists (select customer_id from rental r where c.customer_id = r.customer_id)</span>
<span class="st"> group by c.customer_id</span>
<span class="st">&quot;</span>
)

<span class="kw">print</span>(<span class="kw">glue</span>(<span class="st">&quot;sql_aj1 loj-null costs=&quot;</span>, sql_aj1[<span class="dv">1</span>, <span class="dv">1</span>]))</code></pre>
<pre><code>## sql_aj1 loj-null costs=GroupAggregate  (cost=564.97..570.22 rows=300 width=12) (actual time=252.599..252.770 rows=7 loops=1)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(<span class="kw">glue</span>(<span class="st">&quot;sql_aj3 not exist costs=&quot;</span>, sql_aj3[<span class="dv">1</span>, <span class="dv">1</span>]))</code></pre>
<pre><code>## sql_aj3 not exist costs=HashAggregate  (cost=554.13..557.13 rows=300 width=12) (actual time=249.264..249.325 rows=7 loops=1)</code></pre>
</div>
</div>
<div id="exercises-1" class="section level2">
<h2><span class="header-section-number">12.12</span> Exercises</h2>
<div id="anti-joins-find-customers-who-have-never-rented-a-movie-take-2." class="section level3">
<h3><span class="header-section-number">12.12.1</span> Anti joins – Find customers who have never rented a movie, take 2.</h3>
<p>This is a left outer join from customer to the rental table with an NA rental_id.</p>
<div id="sql-anti-join" class="section level4">
<h4><span class="header-section-number">12.12.1.1</span> SQL Anti-Join</h4>
<pre class="sourceCode r"><code class="sourceCode r">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;select c.first_name</span>
<span class="st">                        ,c.last_name</span>
<span class="st">                        ,c.email</span>
<span class="st">                    from customer c</span>
<span class="st">                         left outer join rental r</span>
<span class="st">                              on c.customer_id = r.customer_id</span>
<span class="st">                   where r.rental_id is null;</span>
<span class="st">                 &quot;</span>
)
<span class="kw">sp_print_df</span>(<span class="kw">head</span>(rs))</code></pre>
<div id="htmlwidget-cc911bce9136bf4e7dfd" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-cc911bce9136bf4e7dfd">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],["Sophie","Ian","Sophie","Ian","John","Ed"],["Yang","Frantz","Yang","Frantz","Smith","Borasky"],["sophie.yang@sakilacustomer.org","ian.frantz@sakilacustomer.org","sophie.yang@sakilacustomer.org","ian.frantz@sakilacustomer.org","john.smith@sakilacustomer.org","ed.borasky@sakilacustomer.org"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>email<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
<p>&lt;– Add dplyr semi-join example –&gt;</p>
</div>
</div>
<div id="sql-rows-per-table" class="section level3">
<h3><span class="header-section-number">12.12.2</span> SQL Rows Per Table</h3>
<p>In the examples above, we looked at how many rows were involved in each of the join examples and which side of the join they came from. It is often helpful to know how many rows are in each table as a sanity check on the joins.</p>
<p>Below is the SQL version to return all the row counts from each table in the DVD Rental System.</p>
<pre class="sourceCode r"><code class="sourceCode r">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;select *</span>
<span class="st">                 from (      select &#39;actor&#39; tbl_name,count(*) from actor </span>
<span class="st">                       union select &#39;category&#39; tbl_name,count(*) from category</span>
<span class="st">                       union select &#39;film&#39; tbl_name,count(*) from film</span>
<span class="st">                       union select &#39;film_actor&#39; tbl_name,count(*) from film_actor</span>
<span class="st">                       union select &#39;film_category&#39; tbl_name,count(*) from film_category</span>
<span class="st">                       union select &#39;language&#39; tbl_name,count(*) from language</span>
<span class="st">                       union select &#39;inventory&#39; tbl_name,count(*) from inventory</span>
<span class="st">                       union select &#39;rental&#39; tbl_name,count(*) from rental</span>
<span class="st">                       union select &#39;payment&#39; tbl_name,count(*) from payment</span>
<span class="st">                       union select &#39;staff&#39; tbl_name,count(*) from staff</span>
<span class="st">                       union select &#39;customer&#39; tbl_name,count(*) from customer</span>
<span class="st">                       union select &#39;address&#39; tbl_name,count(*) from address</span>
<span class="st">                       union select &#39;city&#39; tbl_name,count(*) from city</span>
<span class="st">                       union select &#39;country&#39; tbl_name,count(*) from country</span>
<span class="st">                       union select &#39;store&#39; tbl_name,count(*) from store</span>
<span class="st">                       ) counts</span>
<span class="st">                  order by tbl_name</span>
<span class="st">                 ;</span>
<span class="st">                &quot;</span>
)
<span class="kw">sp_print_df</span>(<span class="kw">head</span>(rs))</code></pre>
<div id="htmlwidget-6c3e37b0fa7ac693f7cc" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6c3e37b0fa7ac693f7cc">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],["actor","address","category","city","country","customer"],[200,603,16,600,109,606]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>tbl_name<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":2},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<pre class="sourceCode r"><code class="sourceCode r">rs</code></pre>
<pre><code>##         tbl_name count
## 1          actor   200
## 2        address   603
## 3       category    16
## 4           city   600
## 5        country   109
## 6       customer   606
## 7           film  1001
## 8     film_actor  5462
## 9  film_category  1000
## 10     inventory  4581
## 11      language     6
## 12       payment 14596
## 13        rental 16044
## 14         staff     2
## 15         store     2</code></pre>
<div id="exercise-dplyr-rows-per-table" class="section level4">
<h4><span class="header-section-number">12.12.2.1</span> Exercise dplyr Rows Per Table</h4>
<p>In the code block below</p>
<ol style="list-style-type: decimal">
<li>Get the row counts for a couple more tables</li>
<li>What is the structure of film_table object?</li>
</ol>
<pre class="sourceCode r"><code class="sourceCode r">film_table &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;film&quot;</span>) <span class="co"># DBI::dbReadTable(con, &quot;customer&quot;)</span>
language_table &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;language&quot;</span>) <span class="co"># DBI::dbReadTable(con, &quot;rental&quot;)</span>

film_rows &lt;-<span class="st"> </span>film_table <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="st">&quot;film&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">rows =</span> <span class="kw">n</span>())
language_rows &lt;-<span class="st"> </span>language_table <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="st">&quot;language&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">rows =</span> <span class="kw">n</span>())
rows_per_table &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">as.data.frame</span>(film_rows), <span class="kw">as.data.frame</span>(language_rows))
rows_per_table</code></pre>
<pre><code>##       name rows
## 1     film 1001
## 2 language    6</code></pre>
</div>
<div id="sql-film-distribution-based-on-language" class="section level4">
<h4><span class="header-section-number">12.12.2.2</span> SQL film distribution based on language</h4>
<p>The SQL below is very similar to the <code>SQL full Outer Join</code> above. Instead of counting the joins, it counts the number films associated with each language.</p>
<pre class="sourceCode r"><code class="sourceCode r">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;select l.language_id id</span>
<span class="st">                       ,l.name</span>
<span class="st">                       ,sum(case when f.language_id is not null then 1 else 0 end) total</span>
<span class="st">                   from language l</span>
<span class="st">                        full outer join film f</span>
<span class="st">                             on l.language_id = f.language_id</span>
<span class="st">                  group by l.language_id,l.name </span>
<span class="st">                  order by l.name;</span>
<span class="st">                 ;</span>
<span class="st">                &quot;</span>
)
<span class="kw">sp_print_df</span>(<span class="kw">head</span>(rs))</code></pre>
<div id="htmlwidget-88984347109043009685" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-88984347109043009685">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],[1,5,6,2,3,4],["English             ","French              ","German              ","Italian             ","Japanese            ","Mandarin            "],[999,0,0,0,0,0]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>id<\/th>\n      <th>name<\/th>\n      <th>total<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<pre class="sourceCode r"><code class="sourceCode r">rs</code></pre>
<pre><code>##   id                 name total
## 1  1 English                999
## 2  5 French                   0
## 3  6 German                   0
## 4  2 Italian                  0
## 5  3 Japanese                 0
## 6  4 Mandarin                 0
## 7 NA                 &lt;NA&gt;     2</code></pre>
</div>
<div id="exercise-dplyr-film-distribution-based-on-language" class="section level4">
<h4><span class="header-section-number">12.12.2.3</span> Exercise dplyr film distribution based on language</h4>
<p>Below is the code block from the <code>dplyr Full Outer Join</code> section above. Modify the code block to match the output from the SQL version.</p>
<pre class="sourceCode r"><code class="sourceCode r">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;select l.language_id,l.name,f.language_id language_id_f,count(*) fojs</span>
<span class="st">   from language l full outer join film f on l.language_id = f.language_id</span>
<span class="st">  group by l.language_id,l.name,f.language_id</span>
<span class="st">order by l.language_id;&quot;</span>
)
<span class="kw">sp_print_df</span>(rs)</code></pre>
<div id="htmlwidget-d80799441e19bf040cbf" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-d80799441e19bf040cbf">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7"],[1,2,3,4,5,6,null],["English             ","Italian             ","Japanese            ","Mandarin            ","French              ","German              ",null],[1,null,null,null,null,null,10],[999,1,1,1,1,1,2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>language_id<\/th>\n      <th>name<\/th>\n      <th>language_id_f<\/th>\n      <th>fojs<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<pre class="sourceCode r"><code class="sourceCode r">rs</code></pre>
<pre><code>##   language_id                 name language_id_f fojs
## 1           1 English                          1  999
## 2           2 Italian                         NA    1
## 3           3 Japanese                        NA    1
## 4           4 Mandarin                        NA    1
## 5           5 French                          NA    1
## 6           6 German                          NA    1
## 7          NA                 &lt;NA&gt;            10    2</code></pre>
</div>
</div>
</div>
<div id="store-analysis" class="section level2">
<h2><span class="header-section-number">12.13</span> Store analysis</h2>
<p>How are the stores performing.</p>
<div id="sql-store-revenue-stream" class="section level3">
<h3><span class="header-section-number">12.13.1</span> SQL store revenue stream</h3>
<p>How are the stores performing? The SQL code shows the payments made to each store in the business.</p>
<pre class="sourceCode r"><code class="sourceCode r">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;select store_id,sum(p.amount) amt,count(*) cnt </span>
<span class="st">                   from payment p </span>
<span class="st">                        join staff s </span>
<span class="st">                          on p.staff_id = s.staff_id  </span>
<span class="st">                 group by store_id order by 2 desc</span>
<span class="st">                 ;</span>
<span class="st">                &quot;</span>
)
<span class="kw">sp_print_df</span>(<span class="kw">head</span>(rs))</code></pre>
<div id="htmlwidget-5bc260cc0681d28b4458" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5bc260cc0681d28b4458">{"x":{"filter":"none","data":[["1","2"],[2,1],[31059.92,30252.12],[7304,7292]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store_id<\/th>\n      <th>amt<\/th>\n      <th>cnt<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div id="exercise-dplyr-store-revenue-stream" class="section level4">
<h4><span class="header-section-number">12.13.1.1</span> Exercise dplyr store revenue stream</h4>
<p>Complete the following code block to return the payments made to each store.</p>
<pre class="sourceCode r"><code class="sourceCode r">payment_table &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;payment&quot;</span>) <span class="co"># DBI::dbReadTable(con, &quot;payment&quot;)</span>
staff_table &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;staff&quot;</span>) <span class="co"># DBI::dbReadTable(con, &quot;staff&quot;)</span>

store_revenue &lt;-<span class="st"> </span>payment_table <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">inner_join</span>(staff_table, <span class="dt">by =</span> <span class="st">&quot;staff_id&quot;</span>, <span class="dt">suffix =</span> <span class="kw">c</span>(<span class="st">&quot;.p&quot;</span>, <span class="st">&quot;.s&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">head</span>()

store_revenue</code></pre>
<pre><code>## # Source:   lazy query [?? x 16]
## # Database: postgres [postgres@localhost:5432/dvdrental]
##   payment_id customer_id staff_id rental_id amount payment_date       
##        &lt;int&gt;       &lt;int&gt;    &lt;int&gt;     &lt;int&gt;  &lt;dbl&gt; &lt;dttm&gt;             
## 1      17503         341        2      1520   7.99 2007-02-15 22:25:46
## 2      17504         341        1      1778   1.99 2007-02-16 17:23:14
## 3      17505         341        1      1849   7.99 2007-02-16 22:41:45
## 4      17506         341        2      2829   2.99 2007-02-19 19:39:56
## 5      17507         341        2      3130   7.99 2007-02-20 17:31:48
## 6      17508         341        1      3382   5.99 2007-02-21 12:33:49
## # ... with 10 more variables: first_name &lt;chr&gt;, last_name &lt;chr&gt;,
## #   address_id &lt;int&gt;, email &lt;chr&gt;, store_id &lt;int&gt;, active &lt;lgl&gt;,
## #   username &lt;chr&gt;, password &lt;chr&gt;, last_update &lt;dttm&gt;, picture &lt;blob&gt;</code></pre>
<!-- answer
    # group_by(store_id) %>%
    # summarize (amt=sum(amount,na.rm=TRUE),n=n()) %>%
    # arrange (desc(amt))
-->
</div>
</div>
<div id="sqlestimate-outstanding-balance" class="section level3">
<h3><span class="header-section-number">12.13.2</span> SQL:Estimate Outstanding Balance</h3>
<p>The following SQL code calculates for each store</p>
<ol style="list-style-type: decimal">
<li>the number of payments still open and closed from the DVD Rental Stores customer base.</li>
<li>the total amount that their customers have paid</li>
<li>the average price per/movie based off of the movies that have been paid.</li>
<li>the estimated outstanding balance based off the open unpaid rentals * the average price per paid movie.</li>
</ol>
<pre class="sourceCode r"><code class="sourceCode r">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;SELECT s.store_id store,sum(CASE WHEN payment_id IS NULL THEN 1 ELSE 0 END) open</span>
<span class="st">    ,sum(CASE WHEN payment_id IS NOT NULL THEN 1 ELSE 0 END) paid</span>
<span class="st">    ,sum(p.amount) paid_amt</span>
<span class="st">    ,count(*) rentals</span>
<span class="st">    ,round(sum(p.amount) / sum(CASE WHEN payment_id IS NOT NULL </span>
<span class="st">                                    THEN 1 </span>
<span class="st">                                    ELSE 0 </span>
<span class="st">                               END), 2) avg_price</span>
<span class="st">    ,round(round(sum(p.amount) / sum(CASE WHEN payment_id IS NOT NULL </span>
<span class="st">                                          THEN 1 </span>
<span class="st">                                          ELSE 0 </span>
<span class="st">                                     END), 2) * sum(CASE WHEN payment_id IS NULL </span>
<span class="st">                                                         THEN 1 </span>
<span class="st">                                                         ELSE 0 </span>
<span class="st">                                                    END), 2) est_balance</span>
<span class="st">FROM rental r</span>
<span class="st">LEFT JOIN payment p</span>
<span class="st">    ON r.rental_id = p.rental_id</span>
<span class="st">JOIN staff s</span>
<span class="st">    ON r.staff_id = s.staff_id</span>
<span class="st">group by s.store_id;</span>
<span class="st">&quot;</span>
)
<span class="kw">sp_print_df</span>(<span class="kw">head</span>(rs))</code></pre>
<div id="htmlwidget-5e6debc8bc477449b2d2" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5e6debc8bc477449b2d2">{"x":{"filter":"none","data":[["1","2"],[1,2],[713,739],[7331,7265],[30498.71,30813.33],[8044,8004],[4.16,4.24],[2966.08,3133.36]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store<\/th>\n      <th>open<\/th>\n      <th>paid<\/th>\n      <th>paid_amt<\/th>\n      <th>rentals<\/th>\n      <th>avg_price<\/th>\n      <th>est_balance<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<pre class="sourceCode r"><code class="sourceCode r">rs</code></pre>
<pre><code>##   store open paid paid_amt rentals avg_price est_balance
## 1     1  713 7331 30498.71    8044      4.16     2966.08
## 2     2  739 7265 30813.33    8004      4.24     3133.36</code></pre>
<div id="exercise-dplyr-modify-the-following-dplyr-code-to-match-the-sql-output-from-above." class="section level4">
<h4><span class="header-section-number">12.13.2.1</span> Exercise Dplyr Modify the following dplyr code to match the SQL output from above.</h4>
<pre class="sourceCode r"><code class="sourceCode r">payment_table &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;payment&quot;</span>) <span class="co"># DBI::dbReadTable(con, &quot;payment&quot;)</span>
rental_table &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;rental&quot;</span>) <span class="co"># DBI::dbReadTable(con, &quot;rental&quot;)</span>

est_bal &lt;-<span class="st"> </span>rental_table <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(payment_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;rental_id&quot;</span>, <span class="st">&quot;rental_id&quot;</span>), <span class="dt">suffix =</span> <span class="kw">c</span>(<span class="st">&quot;.r&quot;</span>, <span class="st">&quot;.p&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">missing =</span>
      <span class="kw">ifelse</span>(<span class="kw">is.na</span>(payment_id), <span class="dv">1</span>, <span class="dv">0</span>), <span class="dt">found =</span> <span class="kw">ifelse</span>(<span class="op">!</span><span class="kw">is.na</span>(payment_id), <span class="dv">1</span>, <span class="dv">0</span>)
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(
    <span class="dt">open =</span>
      <span class="kw">sum</span>(missing, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dt">paid =</span>
      <span class="kw">sum</span>(found, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dt">paid_amt =</span>
      <span class="kw">sum</span>(amount, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dt">rentals =</span> <span class="kw">n</span>()
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(
    <span class="dt">open =</span>
      open, <span class="dt">paid =</span>
      paid, <span class="dt">paid_amt =</span>
      paid_amt, <span class="dt">rentals =</span>
      rentals, <span class="dt">avg_price =</span>
      paid_amt <span class="op">/</span><span class="st"> </span>paid, <span class="dt">est_balance =</span> paid_amt <span class="op">/</span><span class="st"> </span>paid <span class="op">*</span><span class="st"> </span>open
  )
est_bal</code></pre>
<pre><code>## # Source:   lazy query [?? x 6]
## # Database: postgres [postgres@localhost:5432/dvdrental]
##    open  paid paid_amt rentals         avg_price est_balance
##   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;S3: integer64&gt;     &lt;dbl&gt;       &lt;dbl&gt;
## 1  1452 14596   61312. 16048                4.20       6099.</code></pre>
</div>
</div>
<div id="sql-actual-outstanding-balance" class="section level3">
<h3><span class="header-section-number">12.13.3</span> SQL actual outstanding balance</h3>
<p>In the previous exercise, we estimated the outstanding amount. After reviewing the rental table, the actual movie rental rate is in the table. We use that to calculate the outstanding balance below.</p>
<pre class="sourceCode r"><code class="sourceCode r">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;SELECT sum(f.rental_rate) open_amt</span>
<span class="st">    ,count(*) count</span>
<span class="st">FROM rental r</span>
<span class="st">LEFT JOIN payment p</span>
<span class="st">    ON r.rental_id = p.rental_id</span>
<span class="st">INNER JOIN inventory i</span>
<span class="st">    ON r.inventory_id = i.inventory_id</span>
<span class="st">INNER JOIN film f</span>
<span class="st">    ON i.film_id = f.film_id</span>
<span class="st">WHERE p.rental_id IS NULL</span>
<span class="st">;&quot;</span>
)
<span class="kw">sp_print_df</span>(<span class="kw">head</span>(rs))</code></pre>
<div id="htmlwidget-a769f33e9bc2b11da24f" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a769f33e9bc2b11da24f">{"x":{"filter":"none","data":[["1"],[4297.48],[1452]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>open_amt<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<pre class="sourceCode r"><code class="sourceCode r">rs</code></pre>
<pre><code>##   open_amt count
## 1  4297.48  1452</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">payment_table &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;payment&quot;</span>) <span class="co"># DBI::dbReadTable(con, &quot;payment&quot;)</span>
rental_table &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;rental&quot;</span>) <span class="co"># DBI::dbReadTable(con, &quot;rental&quot;)</span>
inventory_table &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;inventory&quot;</span>) <span class="co"># DBI::dbReadTable(con, &quot;inventory&quot;)</span>
film_table &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;film&quot;</span>) <span class="co"># DBI::dbReadTable(con, &quot;film&quot;)</span>

act_bal &lt;-<span class="st"> </span>rental_table <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(payment_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;rental_id&quot;</span>, <span class="st">&quot;rental_id&quot;</span>), <span class="dt">suffix =</span> <span class="kw">c</span>(<span class="st">&quot;.r&quot;</span>, <span class="st">&quot;.p&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">inner_join</span>(inventory_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;inventory_id&quot;</span>, <span class="st">&quot;inventory_id&quot;</span>), <span class="dt">suffix =</span> <span class="kw">c</span>(<span class="st">&quot;.r&quot;</span>, <span class="st">&quot;.i&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">inner_join</span>(film_table, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;film_id&quot;</span>, <span class="st">&quot;film_id&quot;</span>), <span class="dt">suffix =</span> <span class="kw">c</span>(<span class="st">&quot;.i&quot;</span>, <span class="st">&quot;.f&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">head</span>()

act_bal</code></pre>
<pre><code>## # Source:   lazy query [?? x 27]
## # Database: postgres [postgres@localhost:5432/dvdrental]
##   rental_id rental_date         inventory_id customer_id.r
##       &lt;int&gt; &lt;dttm&gt;                     &lt;int&gt;         &lt;int&gt;
## 1         1 2005-05-24 22:53:30          367           130
## 2         2 2005-05-24 22:54:33         1525           459
## 3         3 2005-05-24 23:03:39         1711           408
## 4         4 2005-05-24 23:04:41         2452           333
## 5         5 2005-05-24 23:05:21         2079           222
## 6         6 2005-05-24 23:08:07         2792           549
## # ... with 23 more variables: return_date &lt;dttm&gt;, staff_id.r &lt;int&gt;,
## #   last_update.r &lt;dttm&gt;, payment_id &lt;int&gt;, customer_id.p &lt;int&gt;,
## #   staff_id.p &lt;int&gt;, amount &lt;dbl&gt;, payment_date &lt;dttm&gt;, film_id &lt;int&gt;,
## #   store_id &lt;int&gt;, last_update.i &lt;dttm&gt;, title &lt;chr&gt;, description &lt;chr&gt;,
## #   release_year &lt;int&gt;, language_id &lt;int&gt;, rental_duration &lt;int&gt;,
## #   rental_rate &lt;dbl&gt;, length &lt;int&gt;, replacement_cost &lt;dbl&gt;, rating &lt;S3:
## #   pq_mpaa_rating&gt;, last_update &lt;dttm&gt;, special_features &lt;S3: pq__text&gt;,
## #   fulltext &lt;S3: pq_tsvector&gt;</code></pre>
<!--
    filter(is.na(customer_id.p)) %>%
    summarize(open_amount=sum(rental_rate,na.rm = TRUE)
             ,open = n()
             )
-->
</div>
<div id="rank-customers-with-highest-open-amounts" class="section level3">
<h3><span class="header-section-number">12.13.4</span> Rank customers with highest open amounts</h3>
<pre class="sourceCode r"><code class="sourceCode r">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;select c.customer_id,c.first_name,c.last_name,sum(f.rental_rate) open_amt,count(*) count</span>
<span class="st">                   from rental r </span>
<span class="st">                        left outer join payment p </span>
<span class="st">                          on r.rental_id = p.rental_id  </span>
<span class="st">                        join inventory i</span>
<span class="st">                          on r.inventory_id = i.inventory_id</span>
<span class="st">                        join film f</span>
<span class="st">                          on i.film_id = f.film_id</span>
<span class="st">                        join customer c</span>
<span class="st">                          on r.customer_id = c.customer_id</span>
<span class="st">                  where p.rental_id is null</span>
<span class="st">                  group by c.customer_id,c.first_name,c.last_name</span>
<span class="st">                  order by open_amt desc</span>
<span class="st">                  limit 25</span>
<span class="st">                 ;&quot;</span>
)
<span class="kw">sp_print_df</span>(<span class="kw">head</span>(rs))</code></pre>
<div id="htmlwidget-5afb8971f37330fd8cc4" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5afb8971f37330fd8cc4">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],[293,307,316,299,274,326],["Mae","Joseph","Steven","James","Naomi","Jose"],["Fletcher","Joy","Curley","Gannon","Jennings","Andrew"],[35.9,31.9,31.9,30.91,29.92,28.93],[10,10,10,9,8,7]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>customer_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>open_amt<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<pre class="sourceCode r"><code class="sourceCode r">rs</code></pre>
<pre><code>##    customer_id first_name   last_name open_amt count
## 1          293        Mae    Fletcher    35.90    10
## 2          307     Joseph         Joy    31.90    10
## 3          316     Steven      Curley    31.90    10
## 4          299      James      Gannon    30.91     9
## 5          274      Naomi    Jennings    29.92     8
## 6          326       Jose      Andrew    28.93     7
## 7          338     Dennis      Gilman    27.92     8
## 8          277       Olga     Jimenez    27.92     8
## 9          327      Larry    Thrasher    26.93     7
## 10         330      Scott     Shelley    26.93     7
## 11         322      Jason   Morrissey    26.91     9
## 12         340    Patrick      Newsom    25.92     8
## 13         336     Joshua        Mark    25.92     8
## 14         304      David       Royal    24.93     7
## 15         339     Walter    Perryman    23.94     6
## 16         239     Minnie      Romero    23.94     6
## 17         310     Daniel      Cabral    22.93     7
## 18         296     Ramona        Hale    22.93     7
## 19         313     Donald       Mahon    22.93     7
## 20         287      Becky       Miles    22.93     7
## 21         272        Kay    Caldwell    22.93     7
## 22         303    William Satterfield    22.93     7
## 23         329      Frank    Waggoner    22.91     9
## 24         311       Paul       Trout    21.92     8
## 25         109       Edna        West    20.93     7</code></pre>
</div>
<div id="what-film-has-been-rented-the-most" class="section level3">
<h3><span class="header-section-number">12.13.5</span> what film has been rented the most</h3>
<pre class="sourceCode r"><code class="sourceCode r">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;SELECT i.film_id</span>
<span class="st">    ,f.title</span>
<span class="st">    ,rental_rate</span>
<span class="st">    ,sum(rental_rate) revenue</span>
<span class="st">    ,count(*) count --16044</span>
<span class="st">FROM rental r</span>
<span class="st">INNER JOIN inventory i</span>
<span class="st">    ON r.inventory_id = i.inventory_id</span>
<span class="st">INNER JOIN film f</span>
<span class="st">    ON i.film_id = f.film_id</span>
<span class="st">GROUP BY i.film_id</span>
<span class="st">    ,f.title</span>
<span class="st">    ,rental_rate</span>
<span class="st">ORDER BY count DESC</span>
<span class="st">LIMIT 25</span>
<span class="st">;&quot;</span>
)
<span class="kw">sp_print_df</span>(<span class="kw">head</span>(rs))</code></pre>
<div id="htmlwidget-e9ae68682532316859d5" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-e9ae68682532316859d5">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],[103,738,489,730,767,331],["Bucket Brotherhood","Rocketeer Mother","Juggler Hardly","Ridgemont Submarine","Scalawag Duck","Forward Temple"],[4.99,0.99,0.99,0.99,4.99,2.99],[169.66,32.67,31.68,31.68,159.68,95.68],[34,33,32,32,32,32]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>rental_rate<\/th>\n      <th>revenue<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<pre class="sourceCode r"><code class="sourceCode r">rs</code></pre>
<pre><code>##    film_id               title rental_rate revenue count
## 1      103  Bucket Brotherhood        4.99  169.66    34
## 2      738    Rocketeer Mother        0.99   32.67    33
## 3      489      Juggler Hardly        0.99   31.68    32
## 4      730 Ridgemont Submarine        0.99   31.68    32
## 5      767       Scalawag Duck        4.99  159.68    32
## 6      331      Forward Temple        2.99   95.68    32
## 7      382      Grit Clockwork        0.99   31.68    32
## 8      735        Robbers Joon        2.99   92.69    31
## 9      973           Wife Turn        4.99  154.69    31
## 10     621        Network Peak        2.99   92.69    31
## 11    1000           Zorro Ark        4.99  154.69    31
## 12      31       Apache Divine        4.99  154.69    31
## 13     369   Goodfellas Salute        4.99  154.69    31
## 14     753     Rush Goodfellas        0.99   30.69    31
## 15     891      Timberland Sky        0.99   30.69    31
## 16     418        Hobbit Alien        0.99   30.69    31
## 17     127       Cat Coneheads        4.99  149.70    30
## 18     559          Married Go        2.99   89.70    30
## 19     374       Graffiti Love        0.99   29.70    30
## 20     748 Rugrats Shakespeare        0.99   29.70    30
## 21     239        Dogma Family        4.99  149.70    30
## 22     285    English Bulworth        0.99   29.70    30
## 23     109  Butterfly Chocolat        0.99   29.70    30
## 24     450     Idols Snatchers        2.99   89.70    30
## 25     609       Muscle Bright        2.99   89.70    30</code></pre>
</div>
<div id="what-film-has-been-generated-the-most-revenue-assuming-all-amounts-are-collected" class="section level3">
<h3><span class="header-section-number">12.13.6</span> what film has been generated the most revenue assuming all amounts are collected</h3>
<pre class="sourceCode r"><code class="sourceCode r">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;select i.film_id,f.title,rental_rate</span>
<span class="st">                       ,sum(rental_rate) revenue,count(*) count  --16044</span>
<span class="st">                   from rental r </span>
<span class="st">                        join inventory i</span>
<span class="st">                          on r.inventory_id = i.inventory_id</span>
<span class="st">                        join film f</span>
<span class="st">                          on i.film_id = f.film_id</span>
<span class="st">                 group by i.film_id,f.title,rental_rate</span>
<span class="st">                 order by revenue desc</span>
<span class="st">                 ;&quot;</span>
)
<span class="kw">sp_print_df</span>(<span class="kw">head</span>(rs))</code></pre>
<div id="htmlwidget-32dc6527565d6d2fa8eb" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-32dc6527565d6d2fa8eb">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],[103,767,973,31,369,1000],["Bucket Brotherhood","Scalawag Duck","Wife Turn","Apache Divine","Goodfellas Salute","Zorro Ark"],[4.99,4.99,4.99,4.99,4.99,4.99],[169.66,159.68,154.69,154.69,154.69,154.69],[34,32,31,31,31,31]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>rental_rate<\/th>\n      <th>revenue<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="which-films-are-in-one-store-but-not-the-other." class="section level3">
<h3><span class="header-section-number">12.13.7</span> which films are in one store but not the other.</h3>
<pre class="sourceCode r"><code class="sourceCode r">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;select coalesce(i1.film_id,i2.film_id) film_id</span>
<span class="st">                       ,f.title,f.rental_rate,i1.store_id,i1.count,i2.store_id,i2.count</span>
<span class="st">                   from     (select film_id,store_id,count(*) count </span>
<span class="st">                               from inventory where store_id = 1 </span>
<span class="st">                             group by film_id,store_id) as i1</span>
<span class="st">                         full outer join </span>
<span class="st">                            (select film_id,store_id,count(*) count</span>
<span class="st">                               from inventory where store_id = 2 </span>
<span class="st">                             group by film_id,store_id</span>
<span class="st">                            ) as i2</span>
<span class="st">                           on i1.film_id = i2.film_id </span>
<span class="st">                         join film f </span>
<span class="st">                           on coalesce(i1.film_id,i2.film_id) = f.film_id</span>
<span class="st">                  where i1.film_id is null or i2.film_id is null </span>
<span class="st">                 order by f.title  ;</span>
<span class="st">               &quot;</span>
)
<span class="kw">sp_print_df</span>(<span class="kw">head</span>(rs))</code></pre>
<div id="htmlwidget-bbe1f43178625f07ed69" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-bbe1f43178625f07ed69">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],[2,3,5,8,13,20],["Ace Goldfinger","Adaptation Holes","African Egg","Airport Pollock","Ali Forever","Amelie Hellfighters"],[4.99,2.99,2.99,4.99,4.99,4.99],[null,null,null,null,null,1],[null,null,null,null,null,3],[2,2,2,2,2,null],[3,4,3,4,4,null]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>rental_rate<\/th>\n      <th>store_id<\/th>\n      <th>count<\/th>\n      <th>store_id..6<\/th>\n      <th>count..7<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,3,4,5,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="compute-the-outstanding-balance." class="section level3">
<h3><span class="header-section-number">12.13.8</span> Compute the outstanding balance.</h3>
<pre class="sourceCode r"><code class="sourceCode r">rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;select sum(f.rental_rate) open_amt,count(*) count</span>
<span class="st">                   from rental r </span>
<span class="st">                        left outer join payment p </span>
<span class="st">                          on r.rental_id = p.rental_id  </span>
<span class="st">                        join inventory i</span>
<span class="st">                          on r.inventory_id = i.inventory_id</span>
<span class="st">                        join film f</span>
<span class="st">                          on i.film_id = f.film_id</span>
<span class="st">                  where p.rental_id is null</span>
<span class="st">                 ;&quot;</span>
)
<span class="kw">sp_print_df</span>(<span class="kw">head</span>(rs))</code></pre>
<p><div id="htmlwidget-f44584fa5e4f08aaeb0b" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-f44584fa5e4f08aaeb0b">{"x":{"filter":"none","data":[["1"],[4297.48],[1452]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>open_amt<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
### Which Stores Have Movies That Have Never Rented?</p>
<pre class="sourceCode r"><code class="sourceCode r">not_rented &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con,
          <span class="st">&quot;select i.store_id,f.film_id,f.title,f.description,i.last_update</span>
<span class="st">             from inventory i left outer join rental r </span>
<span class="st">                      on i.inventory_id = r.inventory_id</span>
<span class="st">                  join film f</span>
<span class="st">                      on i.film_id = f.film_id</span>
<span class="st">            where r.inventory_id is null </span>
<span class="st">          &quot;</span>)

<span class="kw">sp_print_df</span>(not_rented)</code></pre>
<div id="htmlwidget-33be21b5fff197bb7cc4" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-33be21b5fff197bb7cc4">{"x":{"filter":"none","data":[["1"],[2],[1],["Academy Dinosaur"],["A Epic Drama of a Feminist And a Mad Scientist who must Battle a Teacher in The Canadian Rockies"],["2006-02-15T18:09:17Z"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>store_id<\/th>\n      <th>film_id<\/th>\n      <th>title<\/th>\n      <th>description<\/th>\n      <th>last_update<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># &#39;View&#39; causes problems with building the book.  Please comment out after using it interactively:</span>

<span class="co"># View(dbGetQuery(con,&quot;select min(last_update) mn, max(last_update) mx from inventory;&quot;))</span>

<span class="co"># View(dbGetQuery(con,&quot;select rental_date,count(*) </span>
<span class="co">#                        from rental</span>
<span class="co">#                      group by rental_date</span>
<span class="co">#                      order by rental_date;&quot;))</span></code></pre>
</div>
</div>
<div id="different-strategies-for-interacting-with-the-database" class="section level2">
<h2><span class="header-section-number">12.14</span> Different strategies for interacting with the database</h2>
<p>select examples
dbGetQuery returns the entire result set as a data frame.<br />
For large returned datasets, complex or inefficient SQL statements, this may take a
long time.</p>
<pre><code>  dbSendQuery: parses, compiles, creates the optimized execution plan.  
      dbFetch: Execute optimzed execution plan and return the dataset.
dbClearResult: remove pending query results from the database to your R environment</code></pre>
<div id="use-dbgetquery" class="section level3">
<h3><span class="header-section-number">12.14.1</span> Use dbGetQuery</h3>
<p>How many customers are there in the DVD Rental System</p>
<pre class="sourceCode r"><code class="sourceCode r">rs1 &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con, <span class="st">&quot;select * from customer;&quot;</span>)
<span class="kw">sp_print_df</span>(<span class="kw">head</span>(rs1))</code></pre>
<div id="htmlwidget-008e7554d5faa93bd1b9" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-008e7554d5faa93bd1b9">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],[524,1,2,3,4,5],[1,1,1,1,2,1],["Jared","Mary","Patricia","Linda","Barbara","Elizabeth"],["Ely","Smith","Johnson","Williams","Jones","Brown"],["jared.ely@sakilacustomer.org","mary.smith@sakilacustomer.org","patricia.johnson@sakilacustomer.org","linda.williams@sakilacustomer.org","barbara.jones@sakilacustomer.org","elizabeth.brown@sakilacustomer.org"],[530,5,6,7,8,9],[true,true,true,true,true,true],["2006-02-14","2006-02-14","2006-02-14","2006-02-14","2006-02-14","2006-02-14"],["2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z"],[1,1,1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>customer_id<\/th>\n      <th>store_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>email<\/th>\n      <th>address_id<\/th>\n      <th>activebool<\/th>\n      <th>create_date<\/th>\n      <th>last_update<\/th>\n      <th>active<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,6,10]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<pre class="sourceCode r"><code class="sourceCode r">pco &lt;-<span class="st"> </span><span class="kw">dbSendQuery</span>(con, <span class="st">&quot;select * from customer;&quot;</span>)
rs2 &lt;-<span class="st"> </span><span class="kw">dbFetch</span>(pco)
<span class="kw">dbClearResult</span>(pco)
<span class="kw">sp_print_df</span>(<span class="kw">head</span>(rs2))</code></pre>
<div id="htmlwidget-f943e07c4e65c2196ba8" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-f943e07c4e65c2196ba8">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],[524,1,2,3,4,5],[1,1,1,1,2,1],["Jared","Mary","Patricia","Linda","Barbara","Elizabeth"],["Ely","Smith","Johnson","Williams","Jones","Brown"],["jared.ely@sakilacustomer.org","mary.smith@sakilacustomer.org","patricia.johnson@sakilacustomer.org","linda.williams@sakilacustomer.org","barbara.jones@sakilacustomer.org","elizabeth.brown@sakilacustomer.org"],[530,5,6,7,8,9],[true,true,true,true,true,true],["2006-02-14","2006-02-14","2006-02-14","2006-02-14","2006-02-14","2006-02-14"],["2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z","2013-05-26T21:49:45Z"],[1,1,1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>customer_id<\/th>\n      <th>store_id<\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>email<\/th>\n      <th>address_id<\/th>\n      <th>activebool<\/th>\n      <th>create_date<\/th>\n      <th>last_update<\/th>\n      <th>active<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,6,10]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="use-dbexecute" class="section level3">
<h3><span class="header-section-number">12.14.2</span> Use dbExecute</h3>
</div>
<div id="anti-join-find-sophie-who-has-never-rented-a-movie." class="section level3">
<h3><span class="header-section-number">12.14.3</span> Anti join – Find Sophie who has never rented a movie.</h3>
<pre class="sourceCode r"><code class="sourceCode r">customer_table &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbReadTable</span>(con, <span class="st">&quot;customer&quot;</span>)
rental_table &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbReadTable</span>(con, <span class="st">&quot;rental&quot;</span>)

customer_tbl &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">tbl</span>(con, <span class="st">&quot;customer&quot;</span>)
rental_tbl &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">tbl</span>(con, <span class="st">&quot;rental&quot;</span>)

dplyr_tbl_loj &lt;-
<span class="st">  </span><span class="kw">left_join</span>(customer_tbl, rental_tbl, <span class="dt">by =</span> <span class="st">&quot;customer_id&quot;</span>, <span class="dt">suffix =</span> <span class="kw">c</span>(<span class="st">&quot;.c&quot;</span>, <span class="st">&quot;.r&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">is.na</span>(rental_id)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="kw">c</span>(<span class="st">&quot;first_name&quot;</span>, <span class="st">&quot;last_name&quot;</span>, <span class="st">&quot;email&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">collect</span>()

rs &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(
  con,
  <span class="st">&quot;select c.first_name</span>
<span class="st">                        ,c.last_name</span>
<span class="st">                        ,c.email</span>
<span class="st">                    from customer c</span>
<span class="st">                         left outer join rental r</span>
<span class="st">                              on c.customer_id = r.customer_id</span>
<span class="st">                   where r.rental_id is null;</span>
<span class="st">                 &quot;</span>
)
<span class="kw">sp_print_df</span>(<span class="kw">head</span>(rs))</code></pre>
<div id="htmlwidget-4b34001b371daf31fcf2" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-4b34001b371daf31fcf2">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],["Sophie","Ian","Sophie","Ian","John","Ed"],["Yang","Frantz","Yang","Frantz","Smith","Borasky"],["sophie.yang@sakilacustomer.org","ian.frantz@sakilacustomer.org","sophie.yang@sakilacustomer.org","ian.frantz@sakilacustomer.org","john.smith@sakilacustomer.org","ed.borasky@sakilacustomer.org"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>email<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sp_print_df</span>(dplyr_tbl_loj)</code></pre>
<div id="htmlwidget-b1bdbba72aec9089045d" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-b1bdbba72aec9089045d">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7"],["Sophie","Ian","Sophie","Ian","John","Ed","John"],["Yang","Frantz","Yang","Frantz","Smith","Borasky","Smith"],["sophie.yang@sakilacustomer.org","ian.frantz@sakilacustomer.org","sophie.yang@sakilacustomer.org","ian.frantz@sakilacustomer.org","john.smith@sakilacustomer.org","ed.borasky@sakilacustomer.org","john.smith@sakilacustomer.org"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>first_name<\/th>\n      <th>last_name<\/th>\n      <th>email<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
<p><div id="htmlwidget-af6ac1c69230c2179f6a" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-af6ac1c69230c2179f6a">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35"],["actor","address","address","category","city","city","country","customer","customer","film","film","film_actor","film_actor","film_actor","film_actor","film_category","film_category","film_category","film_category","inventory","inventory","language","payment","payment","payment","payment","rental","rental","rental","rental","staff","staff","store","store","store"],["actor_id","address_id","city_id","category_id","city_id","country_id","country_id","customer_id","address_id","film_id","language_id","actor_id","actor_id","film_id","film_id","category_id","film_id","category_id","film_id","film_id","inventory_id","language_id","staff_id","customer_id","rental_id","payment_id","customer_id","rental_id","staff_id","inventory_id","staff_id","address_id","store_id","address_id","manager_staff_id"],["actor_pkey","address_pkey","fk_address_city","category_pkey","city_pkey","fk_city","country_pkey","customer_pkey","customer_address_id_fkey","film_pkey","film_language_id_fkey","film_actor_actor_id_fkey","film_actor_pkey","film_actor_pkey","film_actor_film_id_fkey","film_category_category_id_fkey","film_category_pkey","film_category_pkey","film_category_film_id_fkey","inventory_film_id_fkey","inventory_pkey","language_pkey","payment_staff_id_fkey","payment_customer_id_fkey","payment_rental_id_fkey","payment_pkey","rental_customer_id_fkey","rental_pkey","rental_staff_id_key","rental_inventory_id_fkey","staff_pkey","staff_address_id_fkey","store_pkey","store_address_id_fkey","store_manager_staff_id_fkey"],["PRIMARY KEY","PRIMARY KEY","FOREIGN KEY","PRIMARY KEY","PRIMARY KEY","FOREIGN KEY","PRIMARY KEY","PRIMARY KEY","FOREIGN KEY","PRIMARY KEY","FOREIGN KEY","FOREIGN KEY","PRIMARY KEY","PRIMARY KEY","FOREIGN KEY","FOREIGN KEY","PRIMARY KEY","PRIMARY KEY","FOREIGN KEY","FOREIGN KEY","PRIMARY KEY","PRIMARY KEY","FOREIGN KEY","FOREIGN KEY","FOREIGN KEY","PRIMARY KEY","FOREIGN KEY","PRIMARY KEY","FOREIGN KEY","FOREIGN KEY","PRIMARY KEY","FOREIGN KEY","PRIMARY KEY","FOREIGN KEY","FOREIGN KEY"],["","","city","","","country","","","address","","language","actor","","","film","category","","","film","film","","","staff","customer","rental","","customer","","staff","inventory","","address","","address","staff"],["","","city_id","","","country_id","","","address_id","","language_id","actor_id","","","film_id","category_id","","","film_id","film_id","","","staff_id","customer_id","rental_id","","customer_id","","staff_id","inventory_id","","address_id","","address_id","staff_id"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>table_name<\/th>\n      <th>column_name<\/th>\n      <th>constraint_name<\/th>\n      <th>constraint_type<\/th>\n      <th>ref_table<\/th>\n      <th>ref_table_col<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script><div id="htmlwidget-c6cef737dd6a83c62169" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-c6cef737dd6a83c62169">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15"],["actor","address","category","city","country","customer","film","film_actor","film_category","inventory","language","payment","rental","staff","store"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>table_name<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script></p>
<p><div id="htmlwidget-a9e8581aee330d6d5646" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a9e8581aee330d6d5646">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18"],["address","city","customer","film","film_actor","film_actor","film_category","film_category","inventory","payment","payment","payment","rental","rental","rental","staff","store","store"],["city_id","country_id","address_id","language_id","actor_id","film_id","category_id","film_id","film_id","staff_id","customer_id","rental_id","customer_id","staff_id","inventory_id","address_id","address_id","manager_staff_id"],["fk_address_city","fk_city","customer_address_id_fkey","film_language_id_fkey","film_actor_actor_id_fkey","film_actor_film_id_fkey","film_category_category_id_fkey","film_category_film_id_fkey","inventory_film_id_fkey","payment_staff_id_fkey","payment_customer_id_fkey","payment_rental_id_fkey","rental_customer_id_fkey","rental_staff_id_key","rental_inventory_id_fkey","staff_address_id_fkey","store_address_id_fkey","store_manager_staff_id_fkey"],["FOREIGN KEY","FOREIGN KEY","FOREIGN KEY","FOREIGN KEY","FOREIGN KEY","FOREIGN KEY","FOREIGN KEY","FOREIGN KEY","FOREIGN KEY","FOREIGN KEY","FOREIGN KEY","FOREIGN KEY","FOREIGN KEY","FOREIGN KEY","FOREIGN KEY","FOREIGN KEY","FOREIGN KEY","FOREIGN KEY"],["city","country","address","language","actor","film","category","film","film","staff","customer","rental","customer","staff","inventory","address","address","staff"],["city_id","country_id","address_id","language_id","actor_id","film_id","category_id","film_id","film_id","staff_id","customer_id","rental_id","customer_id","staff_id","inventory_id","address_id","address_id","staff_id"],[2,4,6,7,8,8,9,9,10,12,12,12,13,13,13,14,15,15],["table","table","table","table","table","table","table","table","table","table","table","table","table","table","table","table","table","table"],["rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle"],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5],[18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18],[4,5,2,11,1,7,3,7,7,14,6,13,6,14,10,2,2,14],["table","table","table","table","table","table","table","table","table","table","table","table","table","table","table","table","table","table"],["rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle"],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5],[18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>table_name<\/th>\n      <th>column_name<\/th>\n      <th>constraint_name<\/th>\n      <th>constraint_type<\/th>\n      <th>ref_table<\/th>\n      <th>ref_table_col<\/th>\n      <th>src_tbl_id<\/th>\n      <th>type.x<\/th>\n      <th>shape.x<\/th>\n      <th>width.x<\/th>\n      <th>height.x<\/th>\n      <th>fontsize.x<\/th>\n      <th>fk_tbl_id<\/th>\n      <th>type.y<\/th>\n      <th>shape.y<\/th>\n      <th>width.y<\/th>\n      <th>height.y<\/th>\n      <th>fontsize.y<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[7,10,11,12,13,16,17,18]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><div id="htmlwidget-a9c870ee45a861efbc97" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a9c870ee45a861efbc97">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17"],["actor","address","category","city","country","customer","film","film_actor","film_actor","film_category","film_category","inventory","language","payment","rental","staff","store"],["actor_id","address_id","category_id","city_id","country_id","customer_id","film_id","actor_id","film_id","film_id","category_id","inventory_id","language_id","payment_id","rental_id","staff_id","store_id"],["actor_pkey","address_pkey","category_pkey","city_pkey","country_pkey","customer_pkey","film_pkey","film_actor_pkey","film_actor_pkey","film_category_pkey","film_category_pkey","inventory_pkey","language_pkey","payment_pkey","rental_pkey","staff_pkey","store_pkey"],["PRIMARY KEY","PRIMARY KEY","PRIMARY KEY","PRIMARY KEY","PRIMARY KEY","PRIMARY KEY","PRIMARY KEY","PRIMARY KEY","PRIMARY KEY","PRIMARY KEY","PRIMARY KEY","PRIMARY KEY","PRIMARY KEY","PRIMARY KEY","PRIMARY KEY","PRIMARY KEY","PRIMARY KEY"],["","","","","","","","","","","","","","","","",""],["","","","","","","","","","","","","","","","",""],[1,2,3,4,5,6,7,8,8,9,9,10,11,12,13,14,15],["table","table","table","table","table","table","table","table","table","table","table","table","table","table","table","table","table"],["rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle","rectangle"],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5],[18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>table_name<\/th>\n      <th>column_name<\/th>\n      <th>constraint_name<\/th>\n      <th>constraint_type<\/th>\n      <th>ref_table<\/th>\n      <th>ref_table_col<\/th>\n      <th>src_tbl_id<\/th>\n      <th>type.x<\/th>\n      <th>shape.x<\/th>\n      <th>width.x<\/th>\n      <th>height.x<\/th>\n      <th>fontsize.x<\/th>\n      <th>fk_tbl_id<\/th>\n      <th>type.y<\/th>\n      <th>shape.y<\/th>\n      <th>width.y<\/th>\n      <th>height.y<\/th>\n      <th>fontsize.y<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[7,10,11,12,13,16,17,18]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script></p>
<div id="htmlwidget-d0e1be80fd8ee1a19c08" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-d0e1be80fd8ee1a19c08">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18"],[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18],[2,4,6,7,8,8,9,9,10,12,12,12,13,13,13,14,15,15],[4,5,2,11,1,7,3,7,7,14,6,13,6,14,10,2,2,14],["fk","fk","fk","fk","fk","fk","fk","fk","fk","fk","fk","fk","fk","fk","fk","fk","fk","fk"],["fk_address_city","fk_city","customer_address_id_fkey","film_language_id_fkey","film_actor_actor_id_fkey","film_actor_film_id_fkey","film_category_category_id_fkey","film_category_film_id_fkey","inventory_film_id_fkey","payment_staff_id_fkey","payment_customer_id_fkey","payment_rental_id_fkey","rental_customer_id_fkey","rental_staff_id_key","rental_inventory_id_fkey","staff_address_id_fkey","store_address_id_fkey","store_manager_staff_id_fkey"],[15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>id<\/th>\n      <th>from<\/th>\n      <th>to<\/th>\n      <th>rel<\/th>\n      <th>label<\/th>\n      <th>fontsize<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<div id="htmlwidget-41c6fff5c0ae3f9b920c" style="width:672px;height:3000px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-41c6fff5c0ae3f9b920c">{"x":{"diagram":"digraph {\n\ngraph [layout = \"neato\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"circle\",\n      fixedsize = \"true\",\n      width = \"0.5\",\n      style = \"filled\",\n      fillcolor = \"aliceblue\",\n      color = \"gray70\",\n      fontcolor = \"gray50\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray80\",\n     arrowsize = \"0.5\"]\n\n  \"1\" [label = \"actor\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"2\" [label = \"address\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"3\" [label = \"category\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"4\" [label = \"city\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"5\" [label = \"country\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"6\" [label = \"customer\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"7\" [label = \"film\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"8\" [label = \"film_actor\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"9\" [label = \"film_category\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"10\" [label = \"inventory\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"11\" [label = \"language\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"12\" [label = \"payment\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"13\" [label = \"rental\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"14\" [label = \"staff\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n  \"15\" [label = \"store\", shape = \"rectangle\", width = \"1\", height = \"0.5\", fontsize = \"18\", fillcolor = \"#F0F8FF\", fontcolor = \"#000000\"] \n\"2\"->\"4\" [label = \"fk_address_city\", fontsize = \"15\"] \n\"4\"->\"5\" [label = \"fk_city\", fontsize = \"15\"] \n\"6\"->\"2\" [label = \"customer_address_id_fkey\", fontsize = \"15\"] \n\"7\"->\"11\" [label = \"film_language_id_fkey\", fontsize = \"15\"] \n\"8\"->\"1\" [label = \"film_actor_actor_id_fkey\", fontsize = \"15\"] \n\"8\"->\"7\" [label = \"film_actor_film_id_fkey\", fontsize = \"15\"] \n\"9\"->\"3\" [label = \"film_category_category_id_fkey\", fontsize = \"15\"] \n\"9\"->\"7\" [label = \"film_category_film_id_fkey\", fontsize = \"15\"] \n\"10\"->\"7\" [label = \"inventory_film_id_fkey\", fontsize = \"15\"] \n\"12\"->\"14\" [label = \"payment_staff_id_fkey\", fontsize = \"15\"] \n\"12\"->\"6\" [label = \"payment_customer_id_fkey\", fontsize = \"15\"] \n\"12\"->\"13\" [label = \"payment_rental_id_fkey\", fontsize = \"15\"] \n\"13\"->\"6\" [label = \"rental_customer_id_fkey\", fontsize = \"15\"] \n\"13\"->\"14\" [label = \"rental_staff_id_key\", fontsize = \"15\"] \n\"13\"->\"10\" [label = \"rental_inventory_id_fkey\", fontsize = \"15\"] \n\"14\"->\"2\" [label = \"staff_address_id_fkey\", fontsize = \"15\"] \n\"15\"->\"2\" [label = \"store_address_id_fkey\", fontsize = \"15\"] \n\"15\"->\"14\" [label = \"store_manager_staff_id_fkey\", fontsize = \"15\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># diconnect from the db</span>
<span class="kw">dbDisconnect</span>(con)

<span class="kw">sp_docker_stop</span>(<span class="st">&quot;sql-pet&quot;</span>)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">knitr<span class="op">::</span><span class="kw">knit_exit</span>()</code></pre>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="dbi-and-sql-11c.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="sql-quick-start-simple-retrieval-15.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/smithjd/sql-pet/edit/master/13-sql_joins-and-complex-queries.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
